<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>第九章 Kubernetes 数据存储 - 空樹之空的博客</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="百里"><meta name=description content="本章节主要介绍kubernetes的数据存储。 在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的"><meta name=keywords content="Go语言,MySQL,Redis,设计模式,读书笔记,人生感悟"><meta name=generator content="Hugo 0.79.1"><link rel=canonical href=/k8s-storage.html><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.021cece56b7a73d45503de6c44a7f04dc9247fa4d50d932d81c81d1f76ef1efe.css integrity="sha256-Ahzs5Wt6c9RVA95sRKfwTckkf6TVDZMtgcgdH3bvHv4=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/toc.css><meta property="og:title" content="第九章 Kubernetes 数据存储"><meta property="og:description" content="本章节主要介绍kubernetes的数据存储。 在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的"><meta property="og:type" content="article"><meta property="og:url" content="/k8s-storage.html"><meta property="article:published_time" content="2021-10-28T18:08:54+08:00"><meta property="article:modified_time" content="2021-10-28T18:08:54+08:00"><meta itemprop=name content="第九章 Kubernetes 数据存储"><meta itemprop=description content="本章节主要介绍kubernetes的数据存储。 在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的"><meta itemprop=datePublished content="2021-10-28T18:08:54+08:00"><meta itemprop=dateModified content="2021-10-28T18:08:54+08:00"><meta itemprop=wordCount content="6227"><meta itemprop=keywords content="k8s,云原生,kubernetes,"><meta name=twitter:card content="summary"><meta name=twitter:title content="第九章 Kubernetes 数据存储"><meta name=twitter:description content="本章节主要介绍kubernetes的数据存储。 在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>空樹之空</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>首页</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>教程</a></div><ul class=mobile-submenu-list><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>自我驱动</a></div><ul class=mobile-submenu-list><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=mobile-menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><style>.fork-me-on-github{position:absolute;top:0;left:0;border:0}@media(max-width:1080px){.fork-me-on-github{display:none}}</style><a href=https://github.com/yezihack><img class=fork-me-on-github src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png alt="Fork me on GitHub"></a><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>空樹之空</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>首页</a></li><li class=menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=menu-item><a class="menu-item-link menu-parent" href>教程</a><ul class=submenu><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=menu-item><a class="menu-item-link menu-parent" href>自我驱动</a><ul class=submenu><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>第九章 Kubernetes 数据存储</h1><div class=post-meta><time datetime=2021-10-28 class=post-time>2021-10-28</time><div class=post-category><a href=/categories/kubernetes.html>kubernetes</a></div><span class=more-meta>约 6227 字</span>
<span class=more-meta>预计阅读 13 分钟</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div id=post-toc><aside><header><h3>第九章 Kubernetes 数据存储</h3></header><nav id=TableOfContents><ul><li><a href=#基本存储>基本存储</a><ul><li><a href=#emptydir>EmptyDir</a></li><li><a href=#hostpath>HostPath</a></li><li><a href=#nfs>NFS</a></li></ul></li><li><a href=#高级存储>高级存储</a><ul><li><a href=#pv和pvc>PV和PVC</a></li><li><a href=#pv>PV</a></li><li><a href=#pvc>PVC</a></li><li><a href=#生命周期>生命周期</a></li></ul></li><li><a href=#配置存储>配置存储</a><ul><li><a href=#configmap>ConfigMap</a></li><li><a href=#secret>Secret</a></li></ul></li><li><a href=#参考>参考</a></li><li><a href=#关于作者>关于作者</a></li></ul></nav></aside><a href=# id=toc-toggle></a></div><div class=post-content><blockquote><p>本章节主要介绍kubernetes的数据存储。</p></blockquote><p>在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes引入了Volume的概念。</p><p>​ Volume是Pod中能够被多个容器访问的共享目录，它被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下，kubernetes通过Volume实现同一个Pod中不同容器之间的数据共享以及数据的持久化存储。Volume的生命容器不与Pod中单个容器的生命周期相关，当容器终止或者重启时，Volume中的数据也不会丢失。</p><p>kubernetes的Volume支持多种类型，比较常见的有下面几个：</p><ul><li>简单存储：EmptyDir、HostPath、NFS</li><li>高级存储：PV、PVC</li><li>配置存储：ConfigMap、Secret</li></ul><h2 id=基本存储>基本存储</h2><h3 id=emptydir>EmptyDir</h3><p>​ EmptyDir是最基础的Volume类型，一个EmptyDir就是Host上的一个空目录。</p><p>​ EmptyDir是在Pod被分配到Node时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为kubernetes会自动分配一个目录，当Pod销毁时， EmptyDir中的数据也会被永久删除。 EmptyDir用途如下：</p><ul><li><p>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</p></li><li><p>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</p></li></ul><p>接下来，通过一个容器之间文件共享的案例来使用一下EmptyDir。</p><p>​ 在一个Pod中准备两个容器nginx和busybox，然后声明一个Volume分别挂在到两个容器的目录中，然后nginx容器负责向Volume中写日志，busybox中通过命令将日志内容读到控制台。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200413174713773.png?imageslim alt></p><p>创建一个volume-emptydir.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume-emptydir</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.14-alpine</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>  </span><span class=c># 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/nginx</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;tail -f /logs/access.log&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 初始命令，动态读取指定文件中内容</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>  </span><span class=c># 将logs-volume 挂在到busybox容器中，对应的目录为 /logs</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/logs</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> </span><span class=c># 声明volume， name为logs-volume，类型为emptyDir</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建Pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f volume-emptydir.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>volume-emptydir</span> <span class=n>created</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods volume-emptydir -n dev -o wide</span>
<span class=n>NAME</span>                  <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>             <span class=n>NODE</span>   <span class=p>......</span> 
<span class=n>volume-emptydir</span>   <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>97s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>100</span>   <span class=n>node1</span>  <span class=p>......</span>

<span class=c># 通过podIp访问nginx</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.244.1.100</span>
<span class=p>......</span>

<span class=c># 通过kubectl logs命令查看指定容器的标准输出</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl logs -f volume-emptydir -n dev -c busybox</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span> <span class=p>-</span> <span class=p>-</span> <span class=p>[</span><span class=n>13</span><span class=p>/</span><span class=n>Apr</span><span class=p>/</span><span class=n>2020</span><span class=err>:</span><span class=n>10</span><span class=err>:</span><span class=n>58</span><span class=err>:</span><span class=n>47</span> <span class=p>+</span><span class=n>0000</span><span class=p>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=n>200</span> <span class=n>612</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;curl/7.29.0&#34;</span> <span class=s2>&#34;-&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=hostpath>HostPath</h3><p>​ 上节课提到，EmptyDir中数据不会被持久化，它会随着Pod的结束而销毁，如果想简单的将数据持久化到主机中，可以选择HostPath。</p><p>​ HostPath就是将Node主机中一个实际目录挂在到Pod中，以供容器使用，这样的设计就可以保证Pod销毁了，但是数据依据可以存在于Node主机上。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200413214031331.png?imageslim alt></p><p>创建一个volume-hostpath.yaml：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume-hostpath</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/nginx</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;tail -f /logs/access.log&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/logs</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w> 
</span><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/logs</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate </span><span class=w> </span><span class=c># 目录存在就使用，不存在就先创建后使用</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-markdown data-lang=markdown>关于type的值的一点说明：
	DirectoryOrCreate 目录存在就使用，不存在就先创建后使用
	Directory	目录必须存在
	FileOrCreate  文件存在就使用，不存在就先创建后使用
	File 文件必须存在	
    Socket	unix套接字必须存在
	CharDevice	字符设备必须存在
	BlockDevice 块设备必须存在
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建Pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f volume-hostpath.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>volume-hostpath</span> <span class=n>created</span>

<span class=c># 查看Pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods volume-hostpath -n dev -o wide</span>
<span class=n>NAME</span>                  <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>             <span class=n>NODE</span>   <span class=p>......</span>
<span class=n>pod-volume-hostpath</span>   <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>16s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>104</span>   <span class=n>node1</span>  <span class=p>......</span>

<span class=c>#访问nginx</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.244.1.104</span>

<span class=c># 接下来就可以去host的/root/logs目录下查看存储的文件了</span>
<span class=c>###  注意: 下面的操作需要到Pod所在的节点运行（案例中是node1）</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@node1</span> <span class=p>~]</span><span class=c># ls /root/logs/</span>
<span class=n>access</span><span class=p>.</span><span class=n>log</span>  <span class=n>error</span><span class=p>.</span><span class=n>log</span>

<span class=c># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span>
</code></pre></td></tr></table></div></div><h3 id=nfs>NFS</h3><p>​ HostPath可以解决数据持久化的问题，但是一旦Node节点故障了，Pod如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用NFS、CIFS。</p><p>​ NFS是一个网络文件存储系统，可以搭建一台NFS服务器，然后将Pod中的存储直接连接到NFS系统上，这样的话，无论Pod在节点上怎么转移，只要Node跟NFS的对接没问题，数据就可以成功访问。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200413215133559.png?imageslim alt></p><p>1）首先要准备nfs的服务器，这里为了简单，直接是master节点做nfs服务器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 在master上安装nfs服务</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># yum install nfs-utils -y</span>

<span class=c># 准备一个共享目录</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># mkdir /root/data/nfs -pv</span>

<span class=c># 将共享目录以读写权限暴露给192.168.109.0/24网段中的所有主机</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># vim /etc/exports</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># more /etc/exports</span>
<span class=p>/</span><span class=n>root</span><span class=p>/</span><span class=n>data</span><span class=p>/</span><span class=n>nfs</span>     <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>24</span><span class=p>(</span><span class=n>rw</span><span class=p>,</span><span class=n>no_root_squash</span><span class=p>)</span>

<span class=c># 启动nfs服务</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># systemctl start nfs</span>
</code></pre></td></tr></table></div></div><p>2）接下来，要在的每个node节点上都安装下nfs，这样的目的是为了node节点可以驱动nfs设备</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 在node上安装nfs服务，注意不需要启动</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># yum install nfs-utils -y</span>
</code></pre></td></tr></table></div></div><p>3）接下来，就可以编写pod的配置文件了，创建volume-nfs.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume-nfs</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/nginx</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;tail -f /logs/access.log&#34;</span><span class=p>]</span><span class=w> 
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/logs</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>    </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.109.100</span><span class=w>  </span><span class=c>#nfs服务器地址</span><span class=w>
</span><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data/nfs</span><span class=w> </span><span class=c>#共享文件路径</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>4）最后，运行下pod，观察结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f volume-nfs.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>volume-nfs</span> <span class=n>created</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods volume-nfs -n dev</span>
<span class=n>NAME</span>                  <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>volume-nfs</span>        <span class=n>2</span><span class=p>/</span><span class=n>2</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m9s</span>

<span class=c># 查看nfs服务器上的共享目录，发现已经有文件了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># ls /root/data/</span>
<span class=n>access</span><span class=p>.</span><span class=n>log</span>  <span class=n>error</span><span class=p>.</span><span class=n>log</span>
</code></pre></td></tr></table></div></div><h2 id=高级存储>高级存储</h2><h3 id=pv和pvc>PV和PVC</h3><p>​ 前面已经学习了使用NFS提供存储，此时就要求用户会搭建NFS系统，并且会在yaml配置nfs。由于kubernetes支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes引入PV和PVC两种资源对象。</p><p>​ PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下PV由kubernetes管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p><p>​ PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC其实就是用户向kubernetes系统发出的一种资源需求申请。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200514194111567.png?imageslim alt></p><p>使用了PV和PVC之后，工作可以得到进一步的细分：</p><ul><li>存储：存储工程师维护</li><li>PV： kubernetes管理员维护</li><li>PVC：kubernetes用户维护</li></ul><h3 id=pv>PV</h3><p>PV是存储资源的抽象，下面是资源清单文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1  </span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv2</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w> </span><span class=c># 存储类型，与底层真正存储对应</span><span class=w>
</span><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>  </span><span class=c># 存储能力，目前只支持存储空间的设置</span><span class=w>
</span><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>  </span><span class=c># 访问模式</span><span class=w>
</span><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=c># 存储类别</span><span class=w>
</span><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=c># 回收策略</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>PV 的关键配置参数说明：</p><ul><li><p><strong>存储类型</strong></p><p>底层实际存储的类型，kubernetes支持多种存储类型，每种存储类型的配置都有所差异</p></li><li><p><strong>存储能力（capacity）</strong></p></li></ul><p>​ 目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入IOPS、吞吐量等指标的配置</p><ul><li><p><strong>访问模式（accessModes）</strong></p><p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li><li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li><li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p></li><li><p><strong>回收策略（persistentVolumeReclaimPolicy）</strong></p><p>当PV不再被使用了之后，对其的处理方式。目前支持三种策略：</p><ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p></li><li><p><strong>存储类别</strong></p><p>PV可以通过storageClassName参数指定一个存储类别</p><ul><li><p>具有特定类别的PV只能与请求了该类别的PVC进行绑定</p></li><li><p>未设定类别的PV则只能与不请求任何类别的PVC进行绑定</p></li></ul></li><li><p><strong>状态（status）</strong></p><p>一个 PV 的生命周期中，可能会处于4中不同的阶段：</p><ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul></li></ul><p><strong>实验</strong></p><p>使用NFS作为存储，来演示PV的使用，创建3个PV，对应NFS中的3个暴露的路径。</p><ol><li>准备NFS环境</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建目录</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># mkdir /root/data/{pv1,pv2,pv3} -pv</span>

<span class=c># 暴露服务</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># more /etc/exports</span>
<span class=p>/</span><span class=n>root</span><span class=p>/</span><span class=n>data</span><span class=p>/</span><span class=n>pv1</span>     <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>24</span><span class=p>(</span><span class=n>rw</span><span class=p>,</span><span class=n>no_root_squash</span><span class=p>)</span>
<span class=p>/</span><span class=n>root</span><span class=p>/</span><span class=n>data</span><span class=p>/</span><span class=n>pv2</span>     <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>24</span><span class=p>(</span><span class=n>rw</span><span class=p>,</span><span class=n>no_root_squash</span><span class=p>)</span>
<span class=p>/</span><span class=n>root</span><span class=p>/</span><span class=n>data</span><span class=p>/</span><span class=n>pv3</span>     <span class=n>192</span><span class=p>.</span><span class=n>168</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>24</span><span class=p>(</span><span class=n>rw</span><span class=p>,</span><span class=n>no_root_squash</span><span class=p>)</span>

<span class=c># 重启服务</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  systemctl restart nfs</span>
</code></pre></td></tr></table></div></div><ol start=2><li>创建pv.yaml</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class=l>pv1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w> 
</span><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w>
</span><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data/pv1</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.109.100</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class=l>pv2</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w> 
</span><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w>
</span><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data/pv2</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.109.100</span><span class=w>
</span><span class=w>    
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class=l>pv3</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w> 
</span><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>3Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w>
</span><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/root/data/pv3</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.109.100</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建 pv</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pv.yaml</span>
<span class=n>persistentvolume</span><span class=p>/</span><span class=n>pv1</span> <span class=n>created</span>
<span class=n>persistentvolume</span><span class=p>/</span><span class=n>pv2</span> <span class=n>created</span>
<span class=n>persistentvolume</span><span class=p>/</span><span class=n>pv3</span> <span class=n>created</span>

<span class=c># 查看pv</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pv -o wide</span>
<span class=n>NAME</span>   <span class=n>CAPACITY</span>   <span class=n>ACCESS</span> <span class=n>MODES</span>  <span class=n>RECLAIM</span> <span class=n>POLICY</span>  <span class=n>STATUS</span>      <span class=n>AGE</span>   <span class=n>VOLUMEMODE</span>
<span class=n>pv1</span>    <span class=n>1Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>        <span class=n>Available</span>    <span class=n>10s</span>   <span class=n>Filesystem</span>
<span class=n>pv2</span>    <span class=n>2Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>        <span class=n>Available</span>    <span class=n>10s</span>   <span class=n>Filesystem</span>
<span class=n>pv3</span>    <span class=n>3Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>        <span class=n>Available</span>    <span class=n>9s</span>    <span class=n>Filesystem</span>
</code></pre></td></tr></table></div></div><h3 id=pvc>PVC</h3><p>PVC是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=c># 访问模式</span><span class=w>
</span><span class=w>  </span><span class=nt>volumeName</span><span class=p>:</span><span class=w> </span><span class=c># 设置 PVC 的 volumeName 字段为 PV 卷的名称, 这一操作将把新的 PVC 对象绑定到现有的 PV 卷</span><span class=w>
</span><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=c># 存储类别</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=c># 请求空间</span><span class=w>
</span><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>5Gi</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>PVC 的关键配置参数说明：</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>​ 用于描述用户应用对存储资源的访问权限</p><ul><li><p><strong>选择条件（selector）</strong></p><p>通过Label Selector的设置，可使PVC对于系统中己存在的PV进行筛选</p></li><li><p><strong>存储类别（storageClassName）</strong></p><p>PVC在定义时可以设定需要的后端存储的类别，只有设置了该class的pv才能被系统选出</p></li><li><p><strong>资源请求（Resources ）</strong></p><p>描述对存储资源的请求</p></li></ul><p><strong>实验</strong></p><ol><li>创建pvc.yaml，申请pv</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>volumeName</span><span class=p>:</span><span class=w> </span><span class=l>pv1</span><span class=w>
</span><span class=w>      
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc2</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>volumeName</span><span class=p>:</span><span class=w> </span><span class=l>pv2</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc3</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>volumeName</span><span class=p>:</span><span class=w> </span><span class=l>pv3</span><span class=w>
</span></code></pre></td></tr></table></div></div><blockquote><p>注： pvc.spec.volumeName 字段是对pv.metadata.name的选择。这样PV与PVC之间建立关系。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建pvc</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pvc.yaml</span>
<span class=n>persistentvolumeclaim</span><span class=p>/</span><span class=n>pvc1</span> <span class=n>created</span>
<span class=n>persistentvolumeclaim</span><span class=p>/</span><span class=n>pvc2</span> <span class=n>created</span>
<span class=n>persistentvolumeclaim</span><span class=p>/</span><span class=n>pvc3</span> <span class=n>created</span>

<span class=c># 查看pvc</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pvc  -n dev -o wide</span>
<span class=n>NAME</span>   <span class=n>STATUS</span>   <span class=n>VOLUME</span>   <span class=n>CAPACITY</span>   <span class=n>ACCESS</span> <span class=n>MODES</span>   <span class=n>STORAGECLASS</span>   <span class=n>AGE</span>   <span class=n>VOLUMEMODE</span>
<span class=n>pvc1</span>   <span class=n>Bound</span>    <span class=n>pv1</span>      <span class=n>1Gi</span>        <span class=n>RWX</span>                           <span class=n>15s</span>   <span class=n>Filesystem</span>
<span class=n>pvc2</span>   <span class=n>Bound</span>    <span class=n>pv2</span>      <span class=n>2Gi</span>        <span class=n>RWX</span>                           <span class=n>15s</span>   <span class=n>Filesystem</span>
<span class=n>pvc3</span>   <span class=n>Bound</span>    <span class=n>pv3</span>      <span class=n>3Gi</span>        <span class=n>RWX</span>                           <span class=n>15s</span>   <span class=n>Filesystem</span>

<span class=c># 查看pv</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pv -o wide</span>
<span class=n>NAME</span>  <span class=n>CAPACITY</span> <span class=n>ACCESS</span> <span class=n>MODES</span>  <span class=n>RECLAIM</span> <span class=n>POLICY</span>  <span class=n>STATUS</span>    <span class=n>CLAIM</span>       <span class=n>AGE</span>     <span class=n>VOLUMEMODE</span>
<span class=n>pv1</span>    <span class=n>1Gi</span>        <span class=n>RWx</span>        <span class=n>Retain</span>          <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc1</span>    <span class=n>3h37m</span>    <span class=n>Filesystem</span>
<span class=n>pv2</span>    <span class=n>2Gi</span>        <span class=n>RWX</span>        <span class=n>Retain</span>          <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc2</span>    <span class=n>3h37m</span>    <span class=n>Filesystem</span>
<span class=n>pv3</span>    <span class=n>3Gi</span>        <span class=n>RWX</span>        <span class=n>Retain</span>          <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc3</span>    <span class=n>3h37m</span>    <span class=n>Filesystem</span>   
</code></pre></td></tr></table></div></div><ol start=2><li>创建pods.yaml, 使用pv</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod1</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/root/</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume</span><span class=w>
</span><span class=w>      </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span><span class=w>        </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod2</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/root/</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume</span><span class=w>
</span><span class=w>      </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>pvc2</span><span class=w>
</span><span class=w>        </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>        
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pods.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>pod1</span> <span class=n>created</span>
<span class=n>pod</span><span class=p>/</span><span class=n>pod2</span> <span class=n>created</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -o wide</span>
<span class=n>NAME</span>   <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>            <span class=n>NODE</span>   
<span class=n>pod1</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>14s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>69</span>   <span class=n>node1</span>   
<span class=n>pod2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>14s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>70</span>   <span class=n>node1</span>  

<span class=c># 查看pvc</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pvc -n dev -o wide</span>
<span class=n>NAME</span>   <span class=n>STATUS</span>   <span class=n>VOLUME</span>   <span class=n>CAPACITY</span>   <span class=n>ACCESS</span> <span class=n>MODES</span>      <span class=n>AGE</span>   <span class=n>VOLUMEMODE</span>
<span class=n>pvc1</span>   <span class=n>Bound</span>    <span class=n>pv1</span>      <span class=n>1Gi</span>        <span class=n>RWX</span>               <span class=n>94m</span>   <span class=n>Filesystem</span>
<span class=n>pvc2</span>   <span class=n>Bound</span>    <span class=n>pv2</span>      <span class=n>2Gi</span>        <span class=n>RWX</span>               <span class=n>94m</span>   <span class=n>Filesystem</span>
<span class=n>pvc3</span>   <span class=n>Bound</span>    <span class=n>pv3</span>      <span class=n>3Gi</span>        <span class=n>RWX</span>               <span class=n>94m</span>   <span class=n>Filesystem</span>

<span class=c># 查看pv</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pv -n dev -o wide</span>
<span class=n>NAME</span>   <span class=n>CAPACITY</span>   <span class=n>ACCESS</span> <span class=n>MODES</span>   <span class=n>RECLAIM</span> <span class=n>POLICY</span>   <span class=n>STATUS</span>   <span class=n>CLAIM</span>       <span class=n>AGE</span>     <span class=n>VOLUMEMODE</span>
<span class=n>pv1</span>    <span class=n>1Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>           <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc1</span>    <span class=n>5h11m</span>   <span class=n>Filesystem</span>
<span class=n>pv2</span>    <span class=n>2Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>           <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc2</span>    <span class=n>5h11m</span>   <span class=n>Filesystem</span>
<span class=n>pv3</span>    <span class=n>3Gi</span>        <span class=n>RWX</span>            <span class=n>Retain</span>           <span class=n>Bound</span>    <span class=n>dev</span><span class=p>/</span><span class=n>pvc3</span>    <span class=n>5h11m</span>   <span class=n>Filesystem</span>

<span class=c># 查看nfs中的文件存储</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># more /root/data/pv1/out.txt</span>
<span class=n>node1</span>
<span class=n>node1</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># more /root/data/pv2/out.txt</span>
<span class=n>node2</span>
<span class=n>node2</span>
</code></pre></td></tr></table></div></div><h3 id=生命周期>生命周期</h3><p>PVC和PV是一一对应的，PV和PVC之间的相互作用遵循以下生命周期：</p><ul><li><p><strong>资源供应</strong>：管理员手动创建底层存储和PV</p></li><li><p><strong>资源绑定</strong>：用户创建PVC，kubernetes负责根据PVC的声明去寻找PV，并绑定</p><p>在用户定义好PVC之后，系统将根据PVC对存储资源的请求在已存在的PV中选择一个满足条件的</p><ul><li><p>一旦找到，就将该PV与用户定义的PVC进行绑定，用户的应用就可以使用这个PVC了</p></li><li><p>如果找不到，PVC则会无限期处于Pending状态，直到等到系统管理员创建了一个符合其要求的PV</p></li></ul><p>PV一旦绑定到某个PVC上，就会被这个PVC独占，不能再与其他PVC进行绑定了</p></li><li><p><strong>资源使用</strong>：用户可在pod中像volume一样使用pvc</p><p>Pod使用Volume的定义，将PVC挂载到容器内的某个路径进行使用。</p></li><li><p><strong>资源释放</strong>：用户删除pvc来释放pv</p><p>当存储资源使用完毕后，用户可以删除PVC，与该PVC绑定的PV将会被标记为“已释放”，但还不能立刻与其他PVC进行绑定。通过之前PVC写入的数据可能还被留在存储设备上，只有在清除之后该PV才能再次使用。</p></li><li><p><strong>资源回收</strong>：kubernetes根据pv设置的回收策略进行资源的回收</p><p>对于PV，管理员可以设定回收策略，用于设置与之绑定的PVC释放资源之后如何处理遗留数据的问题。只有PV的存储空间完成回收，才能供新的PVC绑定和使用</p></li></ul><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200515002806726.png?imageslim alt></p><h2 id=配置存储>配置存储</h2><h3 id=configmap>ConfigMap</h3><p>ConfigMap是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><p>创建configmap.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>info</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    username:admin
</span><span class=sd>    password:123456</span><span class=w>    
</span></code></pre></td></tr></table></div></div><p>接下来，使用此配置文件创建configmap</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建configmap</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f configmap.yaml</span>
<span class=n>configmap</span><span class=p>/</span><span class=n>configmap</span> <span class=n>created</span>

<span class=c># 查看configmap详情</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl describe cm configmap -n dev</span>
<span class=n>Name</span><span class=err>:</span>         <span class=n>configmap</span>
<span class=n>Namespace</span><span class=err>:</span>    <span class=n>dev</span>
<span class=n>Labels</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Annotations</span><span class=err>:</span>  <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>

<span class=n>Data</span>
<span class=p>====</span>
<span class=n>info</span><span class=err>:</span>
<span class=p>----</span>
<span class=n>username</span><span class=err>:</span><span class=n>admin</span>
<span class=n>password</span><span class=err>:</span><span class=n>123456</span>

<span class=n>Events</span><span class=err>:</span>  <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
</code></pre></td></tr></table></div></div><p>接下来创建一个pod-configmap.yaml，将上面创建的configmap挂载进去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-configmap</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w> </span><span class=c># 将configmap挂载到目录</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/configmap/config</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> </span><span class=c># 引用configmap</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span><span class=w>    </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pod-configmap.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>pod-configmap</span> <span class=n>created</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pod pod-configmap -n dev</span>
<span class=n>NAME</span>            <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pod-configmap</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>6s</span>

<span class=c>#进入容器</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl exec -it pod-configmap -n dev /bin/sh</span>
<span class=c># cd /configmap/config/</span>
<span class=c># ls</span>
<span class=n>info</span>
<span class=c># more info</span>
<span class=n>username</span><span class=err>:</span><span class=n>admin</span>
<span class=n>password</span><span class=err>:</span><span class=n>123456</span>

<span class=c># 可以看到映射已经成功，每个configmap都映射成了一个目录</span>
<span class=c># key---&gt;文件     value----&gt;文件中的内容</span>
<span class=c># 此时如果更新configmap的内容, 容器中的值也会动态更新</span>
</code></pre></td></tr></table></div></div><h3 id=secret>Secret</h3><p>​ 在kubernetes中，还存在一种和ConfigMap非常类似的对象，称为Secret对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p><ol><li>首先使用base64对数据进行编码</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=p>[</span><span class=l>root@master ~]# echo -n &#39;admin&#39; | base64</span><span class=w> </span><span class=c>#准备username</span><span class=w>
</span><span class=w></span><span class=l>YWRtaW4=</span><span class=w>
</span><span class=w></span><span class=p>[</span><span class=l>root@master ~]# echo -n &#39;123456&#39; | base64</span><span class=w> </span><span class=c>#准备password</span><span class=w>
</span><span class=w></span><span class=l>MTIzNDU2</span><span class=w>
</span></code></pre></td></tr></table></div></div><ol start=2><li>接下来编写secret.yaml，并创建Secret</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>YWRtaW4=</span><span class=w>
</span><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>MTIzNDU2</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建secret</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f secret.yaml</span>
<span class=n>secret</span><span class=p>/</span><span class=n>secret</span> <span class=n>created</span>

<span class=c># 查看secret详情</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl describe secret secret -n dev</span>
<span class=n>Name</span><span class=err>:</span>         <span class=n>secret</span>
<span class=n>Namespace</span><span class=err>:</span>    <span class=n>dev</span>
<span class=n>Labels</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Annotations</span><span class=err>:</span>  <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Type</span><span class=err>:</span>  <span class=n>Opaque</span>
<span class=n>Data</span>
<span class=p>====</span>
<span class=n>password</span><span class=err>:</span>  <span class=n>6</span> <span class=n>bytes</span>
<span class=n>username</span><span class=err>:</span>  <span class=n>5</span> <span class=n>bytes</span>
</code></pre></td></tr></table></div></div><ol start=3><li>创建pod-secret.yaml，将上面创建的secret挂载进去：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w> </span><span class=c># 将secret挂载到目录</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/secret/config</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pod-secret.yaml</span>
<span class=n>pod</span><span class=p>/</span><span class=n>pod-secret</span> <span class=n>created</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pod pod-secret -n dev</span>
<span class=n>NAME</span>            <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pod-secret</span>      <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m28s</span>

<span class=c># 进入容器，查看secret信息，发现已经自动解码了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl exec -it pod-secret /bin/sh -n dev</span>
<span class=p>/</span> <span class=c># ls /secret/config/</span>
<span class=n>password</span>  <span class=n>username</span>
<span class=p>/</span> <span class=c># more /secret/config/username</span>
<span class=n>admin</span>
<span class=p>/</span> <span class=c># more /secret/config/password</span>
<span class=n>123456</span>
</code></pre></td></tr></table></div></div><p>至此，已经实现了利用secret实现了信息的编码。</p><blockquote><p>找不到目录, 传送门：<a href=https://sgfoot.com/k8s-mindmap.html>Kubernetes 总纲及脑图</a></p></blockquote><h2 id=参考>参考</h2><ol><li>以上笔记来自于黑马视频课程整理.</li><li>视频入口：<a href=https://www.bilibili.com/video/BV1cK4y1L7Am>https://www.bilibili.com/video/BV1cK4y1L7Am</a></li></ol><h2 id=关于作者>关于作者</h2><p>我的博客：https://www.sgfoot.com</p><p>欢迎关注我的微信公众号【空树之空】，共同学习，一起进步~
<img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20210122112114.png?imageslim alt=空树之空></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>百里</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-10-28</span></p><p class=copyright-item><span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><h1></h1><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20200417142450.jpg?imageslim>
<span>微信打赏</span></label></div></div><footer class=post-footer><div class=post-tags><a href=/tags/k8s.html>k8s</a>
<a href=/tags/%E4%BA%91%E5%8E%9F%E7%94%9F.html>云原生</a>
<a href=/tags/kubernetes.html>kubernetes</a></div><nav class=post-nav><a class=prev href=/k8s-permission.html><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">第十章 Kubernetes 权限认证</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/k8s-ingress.html><span class="next-text nav-default">第八章 Kubernetes Ingress 介绍</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:freeit@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://www.github.com/yezihack rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=copyright-year>&copy;
2020 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author><a href=https://www.sgfoot.com>空樹之空</a>
</span><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span></span>
<span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.c123da21eb8e940c0619f739a9ba5a0058720dfae9a96bafc91016c54983880f.js integrity="sha256-wSPaIeuOlAwGGfc5qbpaAFhyDfrpqWuvyRAWxUmDiA8=" crossorigin=anonymous></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==='localhost')return;var hm=document.createElement("script");hm.async=true;hm.src="https://hm.baidu.com/hm.js?90b270e075265ec9aad9847f47bb1f42";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><script id=baidu_push>(function(){if(window.location.hostname==='localhost')return;var bp=document.createElement('script');bp.async=true;var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>