<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>第七章 Kubernetes Service 介绍 - 空樹之空的博客</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="百里"><meta name=description content="本章节主要介绍kubernetes的流量负载组件：Service。 Service介绍 ​ 在kubernetes中，pod是应用程序的载体，我们"><meta name=keywords content="Go语言,MySQL,Redis,设计模式,读书笔记,人生感悟"><meta name=generator content="Hugo 0.79.1"><link rel=canonical href=/k8s-service.html><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.021cece56b7a73d45503de6c44a7f04dc9247fa4d50d932d81c81d1f76ef1efe.css integrity="sha256-Ahzs5Wt6c9RVA95sRKfwTckkf6TVDZMtgcgdH3bvHv4=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/toc.css><meta property="og:title" content="第七章 Kubernetes Service 介绍"><meta property="og:description" content="本章节主要介绍kubernetes的流量负载组件：Service。 Service介绍 ​ 在kubernetes中，pod是应用程序的载体，我们"><meta property="og:type" content="article"><meta property="og:url" content="/k8s-service.html"><meta property="article:published_time" content="2021-10-28T17:54:44+08:00"><meta property="article:modified_time" content="2021-10-28T17:54:44+08:00"><meta itemprop=name content="第七章 Kubernetes Service 介绍"><meta itemprop=description content="本章节主要介绍kubernetes的流量负载组件：Service。 Service介绍 ​ 在kubernetes中，pod是应用程序的载体，我们"><meta itemprop=datePublished content="2021-10-28T17:54:44+08:00"><meta itemprop=dateModified content="2021-10-28T17:54:44+08:00"><meta itemprop=wordCount content="3842"><meta itemprop=keywords content="k8s,云原生,kubernetes,"><meta name=twitter:card content="summary"><meta name=twitter:title content="第七章 Kubernetes Service 介绍"><meta name=twitter:description content="本章节主要介绍kubernetes的流量负载组件：Service。 Service介绍 ​ 在kubernetes中，pod是应用程序的载体，我们"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>空樹之空</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>首页</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>教程</a></div><ul class=mobile-submenu-list><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>自我驱动</a></div><ul class=mobile-submenu-list><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=mobile-menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><style>.fork-me-on-github{position:absolute;top:0;left:0;border:0}@media(max-width:1080px){.fork-me-on-github{display:none}}</style><a href=https://github.com/yezihack><img class=fork-me-on-github src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png alt="Fork me on GitHub"></a><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>空樹之空</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>首页</a></li><li class=menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=menu-item><a class="menu-item-link menu-parent" href>教程</a><ul class=submenu><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=menu-item><a class="menu-item-link menu-parent" href>自我驱动</a><ul class=submenu><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>第七章 Kubernetes Service 介绍</h1><div class=post-meta><time datetime=2021-10-28 class=post-time>2021-10-28</time><div class=post-category><a href=/categories/kubernetes.html>kubernetes</a></div><span class=more-meta>约 3842 字</span>
<span class=more-meta>预计阅读 8 分钟</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div id=post-toc><aside><header><h3>第七章 Kubernetes Service 介绍</h3></header><nav id=TableOfContents><ul><li><a href=#service介绍>Service介绍</a></li><li><a href=#service使用>Service使用</a><ul><li><a href=#实验环境准备>实验环境准备</a></li><li><a href=#clusterip类型的service>ClusterIP类型的Service</a></li><li><a href=#headliness类型的service>HeadLiness类型的Service</a></li><li><a href=#nodeport类型的service>NodePort类型的Service</a></li><li><a href=#loadbalancer类型的service>LoadBalancer类型的Service</a></li><li><a href=#externalname类型的service>ExternalName类型的Service</a></li></ul></li><li><a href=#参考>参考</a></li><li><a href=#关于作者>关于作者</a></li></ul></nav></aside><a href=# id=toc-toggle></a></div><div class=post-content><blockquote><p>本章节主要介绍kubernetes的流量负载组件：Service。</p></blockquote><h2 id=service介绍>Service介绍</h2><p>​ 在kubernetes中，pod是应用程序的载体，我们可以通过pod的ip来访问应用程序，但是pod的ip地址不是固定的，这也就意味着不方便直接采用pod的ip对服务进行访问。</p><p>​ 为了解决这个问题，kubernetes提供了Service资源，Service会对提供同一个服务的多个pod进行聚合，并且提供一个统一的入口地址。通过访问Service的入口地址就能访问到后面的pod服务。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200408194716912.png?imageslim alt></p><p>​ Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行着一个kube-proxy服务进程。当创建Service的时候会通过api-server向etcd写入创建的service的信息，而kube-proxy会基于监听的机制发现这种Service的变动，然后<strong>它会将最新的Service信息转换成对应的访问规则</strong>。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200509121254425.png?imageslim alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 10.97.97.97:80 是service提供的访问入口</span>
<span class=c># 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，</span>
<span class=c># kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去</span>
<span class=c># 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以。</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@node1</span> <span class=p>~]</span><span class=c># ipvsadm -Ln</span>
<span class=n>IP</span> <span class=n>Virtual</span> <span class=n>Server</span> <span class=n>version</span> <span class=n>1</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>1</span> <span class=p>(</span><span class=n>size</span><span class=p>=</span><span class=n>4096</span><span class=p>)</span>
<span class=n>Prot</span> <span class=n>LocalAddress</span><span class=err>:</span><span class=n>Port</span> <span class=n>Scheduler</span> <span class=n>Flags</span>
  <span class=p>-&gt;</span> <span class=n>RemoteAddress</span><span class=err>:</span><span class=n>Port</span>           <span class=n>Forward</span> <span class=n>Weight</span> <span class=n>ActiveConn</span> <span class=n>InActConn</span>
<span class=n>TCP</span>  <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=err>:</span><span class=n>80</span> <span class=n>rr</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
</code></pre></td></tr></table></div></div><p>kube-proxy目前支持三种工作模式:</p><p><strong>userspace 模式</strong></p><p>​ userspace模式下，kube-proxy会为每一个Service创建一个监听端口，发向Cluster IP的请求被Iptables规则重定向到kube-proxy监听的端口上，kube-proxy根据LB算法选择一个提供服务的Pod并和其建立链接，以将请求转发到Pod上。
​ 该模式下，kube-proxy充当了一个四层负责均衡器的角色。由于kube-proxy运行在userspace中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200509151424280.png?imageslim alt></p><p><strong>iptables 模式</strong></p><p>​ iptables模式下，kube-proxy为service后端的每个Pod创建对应的iptables规则，直接将发向Cluster IP的请求重定向到一个Pod IP。
​ 该模式下kube-proxy不承担四层负责均衡器的角色，只负责创建iptables规则。该模式的优点是较userspace模式效率更高，但不能提供灵活的LB策略，当后端Pod不可用时也无法进行重试。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200509152947714.png?imageslim alt></p><p><strong>ipvs 模式</strong></p><p>​ ipvs模式和iptables类似，kube-proxy监控Pod的变化并创建相应的ipvs规则。ipvs相对iptables转发效率更高。除此以外，ipvs支持更多的LB算法。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200509153731363.png?imageslim alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 此模式必须安装ipvs内核模块，否则会降级为iptables</span>
<span class=c># 开启ipvs</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl edit cm kube-proxy -n kube-system</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@node1</span> <span class=p>~]</span><span class=c># ipvsadm -Ln</span>
<span class=n>IP</span> <span class=n>Virtual</span> <span class=n>Server</span> <span class=n>version</span> <span class=n>1</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>1</span> <span class=p>(</span><span class=n>size</span><span class=p>=</span><span class=n>4096</span><span class=p>)</span>
<span class=n>Prot</span> <span class=n>LocalAddress</span><span class=err>:</span><span class=n>Port</span> <span class=n>Scheduler</span> <span class=n>Flags</span>
  <span class=p>-&gt;</span> <span class=n>RemoteAddress</span><span class=err>:</span><span class=n>Port</span>           <span class=n>Forward</span> <span class=n>Weight</span> <span class=n>ActiveConn</span> <span class=n>InActConn</span>
<span class=n>TCP</span>  <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=err>:</span><span class=n>80</span> <span class=n>rr</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
</code></pre></td></tr></table></div></div><h2 id=service使用>Service使用</h2><h3 id=实验环境准备>实验环境准备</h3><p>在使用service之前，首先利用Deployment创建出3个pod，注意要为pod设置<code>app=nginx-pod</code>的标签</p><p>创建deployment.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>apiVersion: apps/v1
kind: Deployment      
metadata:
  name: pc-deployment
  namespace: dev 
spec: 
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f deployment.yaml</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>created</span>

<span class=c># 查看pod详情</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -o wide --show-labels</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>     <span class=n>IP</span>            <span class=n>NODE</span>     <span class=n>LABELS</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>66cb59b984</span><span class=p>-</span><span class=n>8p84h</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>    <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span>   <span class=n>node1</span>    <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>66cb59b984-vx8vx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>    <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>   <span class=n>node2</span>    <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>66cb59b984-wnncx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>    <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span>   <span class=n>node1</span>    <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>

<span class=c># 为了方便后面的测试，修改下三台nginx的index.html页面（三台修改的IP地址不一致）</span>
<span class=c># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
<span class=c># echo &#34;10.244.1.40&#34; &gt; /usr/share/nginx/html/index.html</span>

<span class=c>#修改完毕之后，访问测试</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.244.1.40</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.244.2.33</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.244.1.39</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span>
</code></pre></td></tr></table></div></div><h3 id=clusterip类型的service>ClusterIP类型的Service</h3><p>创建service-clusterip.yaml文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-clusterip</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=m>10.97.97.97</span><span class=w> </span><span class=c># service的ip地址，如果不写，默认会生成一个</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>  </span><span class=c># Service端口       </span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w> </span><span class=c># pod端口</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f service-clusterip.yaml</span>
<span class=n>service</span><span class=p>/</span><span class=n>service-clusterip</span> <span class=n>created</span>

<span class=c># 查看service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get svc -n dev -o wide</span>
<span class=n>NAME</span>                <span class=nb>TYPE </span>       <span class=n>CLUSTER-IP</span>    <span class=n>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>   <span class=n>AGE</span>   <span class=n>SELECTOR</span>
<span class=n>service-clusterip</span>   <span class=n>ClusterIP</span>   <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>    <span class=n>13s</span>   <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>

<span class=c># 查看service的详细信息</span>
<span class=c># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl describe svc service-clusterip -n dev</span>
<span class=n>Name</span><span class=err>:</span>              <span class=n>service-clusterip</span>
<span class=n>Namespace</span><span class=err>:</span>         <span class=n>dev</span>
<span class=n>Labels</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Annotations</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Selector</span><span class=err>:</span>          <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>
<span class=n>Type</span><span class=err>:</span>              <span class=n>ClusterIP</span>
<span class=n>IP</span><span class=err>:</span>                <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span>
<span class=n>Port</span><span class=err>:</span>              <span class=p>&lt;</span><span class=n>unset</span><span class=p>&gt;</span>  <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
<span class=n>TargetPort</span><span class=err>:</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
<span class=n>Endpoints</span><span class=err>:</span>         <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>
<span class=n>Session</span> <span class=n>Affinity</span><span class=err>:</span>  <span class=n>None</span>
<span class=n>Events</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>

<span class=c># 查看ipvs的映射规则</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># ipvsadm -Ln</span>
<span class=n>TCP</span>  <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=err>:</span><span class=n>80</span> <span class=n>rr</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>

<span class=c># 访问10.97.97.97:80观察效果</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># curl 10.97.97.97:80</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
</code></pre></td></tr></table></div></div><p><strong>Endpoint</strong></p><p>Endpoint是kubernetes中的一个资源对象，存储在etcd中，用来记录一个service对应的所有pod的访问地址，它是根据service配置文件中selector描述产生的。</p><p>一个Service由一组Pod组成，这些Pod通过Endpoints暴露出来，<strong>Endpoints是实现实际服务的端点集合</strong>。换句话说，service和pod之间的联系是通过endpoints实现的。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200509191917069.png?imageslim alt=image-20200509191917069></p><p><strong>负载分发策略</strong></p><p>对Service的访问被分发到了后端的Pod上去，目前kubernetes提供了两种负载分发策略：</p><ul><li><p>如果不定义，默认使用kube-proxy的策略，比如随机、轮询</p></li><li><p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个Pod上</p><p>此模式可以使在spec中添加<code>sessionAffinity:ClientIP</code>选项</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 查看ipvs的映射规则【rr 轮询】</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># ipvsadm -Ln</span>
<span class=n>TCP</span>  <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=err>:</span><span class=n>80</span> <span class=n>rr</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>

<span class=c># 循环访问测试</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>

<span class=c># 修改分发策略----sessionAffinity:ClientIP</span>

<span class=c># 查看ipvs规则【persistent 代表持久】</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># ipvsadm -Ln</span>
<span class=n>TCP</span>  <span class=n>10</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=p>.</span><span class=n>97</span><span class=err>:</span><span class=n>80</span> <span class=n>rr</span> <span class=n>persistent</span> <span class=n>10800</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>
  <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>               <span class=n>Masq</span>    <span class=n>1</span>      <span class=n>0</span>          <span class=n>0</span>

<span class=c># 循环访问测试</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># while true;do curl 10.97.97.97; sleep 5; done;</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
<span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
  
<span class=c># 删除service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete -f service-clusterip.yaml</span>
<span class=n>service</span> <span class=s2>&#34;service-clusterip&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h3 id=headliness类型的service>HeadLiness类型的Service</h3><p>在某些场景中，开发人员可能不想使用Service提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes提供了HeadLiness Service，这类Service不会分配Cluster IP，如果想要访问service，只能通过service的域名进行查询。</p><p>创建service-headliness.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-headliness</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w> </span><span class=c># 将clusterIP设置为None，即可创建headliness Service</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>    
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f service-headliness.yaml</span>
<span class=n>service</span><span class=p>/</span><span class=n>service-headliness</span> <span class=n>created</span>

<span class=c># 获取service， 发现CLUSTER-IP未分配</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get svc service-headliness -n dev -o wide</span>
<span class=n>NAME</span>                 <span class=nb>TYPE </span>       <span class=n>CLUSTER-IP</span>   <span class=n>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>   <span class=n>AGE</span>   <span class=n>SELECTOR</span>
<span class=n>service-headliness</span>   <span class=n>ClusterIP</span>   <span class=n>None</span>         <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>    <span class=n>11s</span>   <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>

<span class=c># 查看service详情</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl describe svc service-headliness  -n dev</span>
<span class=n>Name</span><span class=err>:</span>              <span class=n>service-headliness</span>
<span class=n>Namespace</span><span class=err>:</span>         <span class=n>dev</span>
<span class=n>Labels</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Annotations</span><span class=err>:</span>       <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>
<span class=n>Selector</span><span class=err>:</span>          <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>
<span class=n>Type</span><span class=err>:</span>              <span class=n>ClusterIP</span>
<span class=n>IP</span><span class=err>:</span>                <span class=n>None</span>
<span class=n>Port</span><span class=err>:</span>              <span class=p>&lt;</span><span class=n>unset</span><span class=p>&gt;</span>  <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
<span class=n>TargetPort</span><span class=err>:</span>        <span class=n>80</span><span class=p>/</span><span class=n>TCP</span>
<span class=n>Endpoints</span><span class=err>:</span>         <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span><span class=err>:</span><span class=n>80</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span><span class=err>:</span><span class=n>80</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span><span class=err>:</span><span class=n>80</span>
<span class=n>Session</span> <span class=n>Affinity</span><span class=err>:</span>  <span class=n>None</span>
<span class=n>Events</span><span class=err>:</span>            <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>

<span class=c># 查看域名的解析情况</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
<span class=p>/</span> <span class=c># cat /etc/resolv.conf</span>
<span class=n>nameserver</span> <span class=n>10</span><span class=p>.</span><span class=n>96</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>10</span>
<span class=n>search</span> <span class=n>dev</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span> <span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span> <span class=n>cluster</span><span class=p>.</span><span class=n>local</span>

<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
<span class=n>service-headliness</span><span class=p>.</span><span class=n>dev</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span><span class=p>.</span> <span class=n>30</span> <span class=k>IN</span> <span class=n>A</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>40</span>
<span class=n>service-headliness</span><span class=p>.</span><span class=n>dev</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span><span class=p>.</span> <span class=n>30</span> <span class=k>IN</span> <span class=n>A</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>39</span>
<span class=n>service-headliness</span><span class=p>.</span><span class=n>dev</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span><span class=p>.</span> <span class=n>30</span> <span class=k>IN</span> <span class=n>A</span> <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>33</span>
</code></pre></td></tr></table></div></div><h3 id=nodeport类型的service>NodePort类型的Service</h3><p>在之前的样例中，创建的Service的ip地址只有集群内部才可以访问，如果希望将Service暴露给集群外部使用，那么就要使用到另外一种类型的Service，称为NodePort类型。NodePort的工作原理其实就是<strong>将service的端口映射到Node的一个端口上</strong>，然后就可以通过<code>NodeIp:NodePort</code>来访问service了。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200620175731338.png?imageslim alt></p><p>创建service-nodeport.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-nodeport</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w> </span><span class=c># service类型</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w> </span><span class=c># 指定绑定的node的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f service-nodeport.yaml</span>
<span class=n>service</span><span class=p>/</span><span class=n>service-nodeport</span> <span class=n>created</span>

<span class=c># 查看service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get svc -n dev -o wide</span>
<span class=n>NAME</span>               <span class=nb>TYPE </span>      <span class=n>CLUSTER-IP</span>      <span class=n>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>       <span class=n>SELECTOR</span>
<span class=n>service-nodeport</span>   <span class=n>NodePort</span>   <span class=n>10</span><span class=p>.</span><span class=n>105</span><span class=p>.</span><span class=n>64</span><span class=p>.</span><span class=n>191</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=err>:</span><span class=n>30002</span><span class=p>/</span><span class=n>TCP</span>  <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>

<span class=c># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的30002端口，即可访问到pod</span>
</code></pre></td></tr></table></div></div><h3 id=loadbalancer类型的service>LoadBalancer类型的Service</h3><p>LoadBalancer和NodePort很相似，目的都是向外部暴露一个端口，区别在于LoadBalancer会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200510103945494.png?imageslim alt></p><h3 id=externalname类型的service>ExternalName类型的Service</h3><p>ExternalName类型的Service用于引入集群外部的服务，它通过<code>externalName</code>属性指定外部一个服务的地址，然后在集群内部访问此service就可以访问到外部的服务了。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200510113311209.png?imageslim alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-externalname</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ExternalName</span><span class=w> </span><span class=c># service类型</span><span class=w>
</span><span class=w>  </span><span class=nt>externalName</span><span class=p>:</span><span class=w> </span><span class=l>www.baidu.com </span><span class=w> </span><span class=c>#改成ip地址也可以</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl  create -f service-externalname.yaml</span>
<span class=n>service</span><span class=p>/</span><span class=n>service-externalname</span> <span class=n>created</span>

<span class=c># 域名解析</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
<span class=n>service-externalname</span><span class=p>.</span><span class=n>dev</span><span class=p>.</span><span class=n>svc</span><span class=p>.</span><span class=n>cluster</span><span class=p>.</span><span class=n>local</span><span class=p>.</span> <span class=n>30</span> <span class=k>IN</span> <span class=n>CNAME</span> <span class=n>www</span><span class=p>.</span><span class=n>baidu</span><span class=p>.</span><span class=n>com</span><span class=p>.</span>
<span class=n>www</span><span class=p>.</span><span class=n>baidu</span><span class=p>.</span><span class=n>com</span><span class=p>.</span>          <span class=n>30</span>      <span class=k>IN</span>      <span class=n>CNAME</span>   <span class=n>www</span><span class=p>.</span><span class=n>a</span><span class=p>.</span><span class=n>shifen</span><span class=p>.</span><span class=n>com</span><span class=p>.</span>
<span class=n>www</span><span class=p>.</span><span class=n>a</span><span class=p>.</span><span class=n>shifen</span><span class=p>.</span><span class=n>com</span><span class=p>.</span>       <span class=n>30</span>      <span class=k>IN</span>      <span class=n>A</span>       <span class=n>39</span><span class=p>.</span><span class=n>156</span><span class=p>.</span><span class=n>66</span><span class=p>.</span><span class=n>18</span>
<span class=n>www</span><span class=p>.</span><span class=n>a</span><span class=p>.</span><span class=n>shifen</span><span class=p>.</span><span class=n>com</span><span class=p>.</span>       <span class=n>30</span>      <span class=k>IN</span>      <span class=n>A</span>       <span class=n>39</span><span class=p>.</span><span class=n>156</span><span class=p>.</span><span class=n>66</span><span class=p>.</span><span class=n>14</span>
</code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><ol><li>以上笔记来自于黑马视频课程整理.</li><li>视频入口：<a href=https://www.bilibili.com/video/BV1cK4y1L7Am>https://www.bilibili.com/video/BV1cK4y1L7Am</a></li></ol><h2 id=关于作者>关于作者</h2><p>我的博客：https://www.sgfoot.com</p><p>欢迎关注我的微信公众号【空树之空】，共同学习，一起进步~
<img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20210122112114.png?imageslim alt=空树之空></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>百里</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-10-28</span></p><p class=copyright-item><span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><h1></h1><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20200417142450.jpg?imageslim>
<span>微信打赏</span></label></div></div><footer class=post-footer><div class=post-tags><a href=/tags/k8s.html>k8s</a>
<a href=/tags/%E4%BA%91%E5%8E%9F%E7%94%9F.html>云原生</a>
<a href=/tags/kubernetes.html>kubernetes</a></div><nav class=post-nav><a class=prev href=/k8s-ingress.html><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">第八章 Kubernetes Ingress 介绍</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/k8s-pod-controller.html><span class="next-text nav-default">第六章 Kubernetes Pod 控制器</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:freeit@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://www.github.com/yezihack rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=copyright-year>&copy;
2020 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author><a href=https://www.sgfoot.com>空樹之空</a>
</span><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span></span>
<span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.c123da21eb8e940c0619f739a9ba5a0058720dfae9a96bafc91016c54983880f.js integrity="sha256-wSPaIeuOlAwGGfc5qbpaAFhyDfrpqWuvyRAWxUmDiA8=" crossorigin=anonymous></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==='localhost')return;var hm=document.createElement("script");hm.async=true;hm.src="https://hm.baidu.com/hm.js?90b270e075265ec9aad9847f47bb1f42";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><script id=baidu_push>(function(){if(window.location.hostname==='localhost')return;var bp=document.createElement('script');bp.async=true;var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>