<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.14549c76bbc96f0af1574b0259efd70e52908cd36fb4d14ed3d290a1b6479eae.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>空树之空 - Elasticsearch 入门(四) 查询</title><meta property="og:title" content="空树之空 - Elasticsearch 入门(四) 查询"><meta name=twitter:title content="空树之空 - Elasticsearch 入门(四) 查询"><meta itemprop=name content="空树之空 - Elasticsearch 入门(四) 查询"><meta name=application-name content="空树之空 - Elasticsearch 入门(四) 查询"><meta property="og:site_name" content="空树之空"><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://yezihack.github.io/posts/es-search/><link rel=canonical href=https://yezihack.github.io/posts/es-search/ itemprop=url><meta name=url content="https://yezihack.github.io/posts/es-search/"><meta name=twitter:url content="https://yezihack.github.io/posts/es-search/"><meta property="og:url" content="https://yezihack.github.io/posts/es-search/"><meta property="og:updated_time" content="15007-15-07T752:52:20+0800"><link rel=sitemap type=application/xml title=Sitemap href=https://yezihack.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content="空树之空"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="15007-15-07T752:52:20+0800"><meta property="article:published_time" content="15007-15-07T752:52:20+0800"><meta property="og:article:author" content="百里"><meta property="article:author" content="百里"><meta name=author content="百里"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Elasticsearch 入门(四) 查询","author":{"@type":"Person","name":""},"datePublished":"2020-07-15","description":"","wordCount":"1697","mainEntityOfPage":"True","dateModified":"2020-07-15","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"空树之空","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.114.0"><link type=text/css rel=stylesheet href=/css/bundle.min.aa949ea27ee9836d60d6ea4c073fd0885f51948c7eea0247da6b1aff4bc25c44.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body class=dark-theme><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://yezihack.github.io/><img src=/images/head.jpg alt="brand image"></a>
<a href=https://yezihack.github.io/><h1>空树之空</h1></a></h1><p class=lead>《空樹之空》博客是一个技术导向的平台，聚焦于Kubernetes、DevOps和Linux等领域。通过简洁而优美的文字，我们提供对这些技术主题的深入探索和实用的指南。</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://yezihack.github.io/posts/haproxy-keepalived/>Haproxy + Keepalived 实现 k8s 集群高可用</a></li><li class=bullet><a href=https://yezihack.github.io/posts/istio-ratelimit/>Istio 限流实现</a></li><li class=bullet><a href=https://yezihack.github.io/posts/istio-install/>Istio 安装</a></li><li class=bullet><a href=https://yezihack.github.io/posts/etcd-v3.2/>云运维笔记(10) Etcd V3.2 集群二进制搭建</a></li><li class=bullet><a href=https://yezihack.github.io/posts/etcd-v3.4/>云运维笔记(11) Etcd V3.4 集群二进制搭建</a></li><li class=heading><a href=/tags/>Tags</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=https://yezihack.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote><br>&copy; 2023 百里江山. All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://yezihack.github.io/posts/es-search/>Elasticsearch 入门(四) 查询</a></h1><time datetime=2020-07-15T19:52:52+0800 class=post-date>July 15, 2020</time><ul class=tags><li class=tag-elasticsearch><a href=https://yezihack.github.io/tags/elasticsearch>elasticsearch</a></li><li class=tag-elk><a href=https://yezihack.github.io/tags/elk>elk</a></li></ul></div><h2 id=概要>概要</h2><p>Elasticsearch对外提供的API遵循REST原则</p><ol><li>GET</li><li>POST</li><li>PUT</li><li>DELETE</li></ol><h2 id=简介>简介</h2><ol><li><code>_index</code> 索引, 文档在哪儿存放</li><li><code>_type</code> 类型, 7.x以后都使用 <code>_doc</code>类型</li><li><code>_id</code> 文档唯一标识, 不指定则自动生成.</li></ol><p>一个文档的 <code>_index</code> 、<code> _type</code> 和 <code>_id</code> 唯一标识一个文档</p><h2 id=基本restful操作>基本RESTful操作</h2><h3 id=新增记录-create>新增记录 create</h3><p>二种操作. <code>PUT</code>, <code>POST</code></p><p>PUT方法, <code>/{_index}/_create/{id}</code> 如果文档存在,操作失败</p><p>还可以使用 <code>/{_index}/_doc/{id}?op_type=create</code></p><pre tabindex=0><code># 创建一个文档, 如果文档存在,操作失败
# 使用_create
PUT /student/_create/1
{
  &#34;name&#34;: &#34;张三&#34;,
  &#34;age&#34;:19,
  &#34;sex&#34;:1
}
# 使用 _doc指定操作类型
PUT /student/_doc/3?op_type=create
{
  &#34;name&#34;: &#34;张三丰&#34;,
  &#34;age&#34;:600,
  &#34;sex&#34;:1
}

# 自动生成ID
PUT /student/_doc/
{
  &#34;name&#34;: &#34;张三元&#34;,
  &#34;age&#34;:600,
  &#34;sex&#34;:1
}
</code></pre><p>POST方法 <code>{index}/_doc/{id}</code> 如果文档不存在则创建新文档, 文档存在则旧文档删除, 新的文档被索引, 版本信息+1</p><pre tabindex=0><code>
POST /student/_doc/2
{
  &#34;name&#34;: &#34;阳明&#34;,
  &#34;age&#34;:290,
  &#34;sex&#34;:1
}
</code></pre><p>返回JSON</p><pre tabindex=0><code>{
  &#34;_index&#34; : &#34;student&#34;, # 索引名称
  &#34;_type&#34; : &#34;_doc&#34;, # 类型, 默认为 _doc
  &#34;_id&#34; : &#34;2&#34;, # 标识ID
  &#34;_version&#34; : 5, # 更新版本次数. 5代表此文档更新过5次.
  &#34;result&#34; : &#34;updated&#34;, # 此操作类型为更新操作完成
  &#34;_shards&#34; : { #
    &#34;total&#34; : 2,
    &#34;successful&#34; : 1,
    &#34;failed&#34; : 0
  },
  &#34;_seq_no&#34; : 5,
  &#34;_primary_term&#34; : 1
}
</code></pre><h3 id=获取文档-get>获取文档 get</h3><p>GET <code>{_index}/{_type}/{id}</code></p><pre tabindex=0><code>GET /student/_doc/2

{
  &#34;_index&#34; : &#34;student&#34;, # 索引名称
  &#34;_type&#34; : &#34;_doc&#34;, # 类型名称
  &#34;_id&#34; : &#34;2&#34;, # 标识ID
  &#34;_version&#34; : 5, # 版本次数
  &#34;_seq_no&#34; : 5,
  &#34;_primary_term&#34; : 1,
  &#34;found&#34; : true, # true 代表找到信息
  &#34;_source&#34; : { # 文档的原则信息
    &#34;name&#34; : &#34;阳明&#34;,
    &#34;age&#34; : 290,
    &#34;sex&#34; : 1
  }
}
</code></pre><h3 id=更新文档-update>更新文档 update</h3><blockquote><p>每次更新,注意查看 _version 版本号的变化</p></blockquote><p>Update 方法, 与上面的<code>/{_index}/_doc/{id}</code> 更新不一样, 它是删除后再创建. 而update是真实的更新字段</p><pre tabindex=0><code>

POST /student/_update/2
{
  &#34;doc&#34;:{
    &#34;age&#34;:300,
    &#34;sex&#34;:1
  }
}
</code></pre><p>查看下</p><pre tabindex=0><code>GET /student/_doc/2
{
  &#34;_index&#34; : &#34;student&#34;,
  &#34;_type&#34; : &#34;_doc&#34;,
  &#34;_id&#34; : &#34;2&#34;,
  &#34;_version&#34; : 2,
  &#34;_seq_no&#34; : 12,
  &#34;_primary_term&#34; : 1,
  &#34;found&#34; : true,
  &#34;_source&#34; : {
    &#34;name&#34; : &#34;阳明&#34;,
    &#34;sex&#34; : 1, # 新增的两个字段
    &#34;age&#34; : 300
  }
}
</code></pre><h3 id=删除文档-delete>删除文档 delete</h3><pre tabindex=0><code># 删除文档
DELETE /student/_doc/2
</code></pre><h2 id=bulk-批量操作>bulk 批量操作</h2><blockquote><p>支持创建, 更新,删除操作</p></blockquote><ol><li>index 表示创建或更新文档, 后跟要{}要创建的文档信息</li><li>delete 删除文档</li><li>create 创建文档, 后跟{}要创建的文档信息</li><li>update 更新文档, 后跟{}要更新的文档信息</li></ol><pre tabindex=0><code>POST /_bulk?pretty
{ &#34;index&#34; : { &#34;_index&#34; : &#34;test&#34;, &#34;_id&#34; : &#34;1&#34; } } 
{ &#34;field1&#34; : &#34;value1&#34; }
{ &#34;delete&#34; : { &#34;_index&#34; : &#34;test&#34;, &#34;_id&#34; : &#34;2&#34; } }
{ &#34;create&#34; : { &#34;_index&#34; : &#34;test&#34;, &#34;_id&#34; : &#34;3&#34; } }
{ &#34;field1&#34; : &#34;value3&#34; }
{ &#34;update&#34; : {&#34;_id&#34; : &#34;1&#34;, &#34;_index&#34; : &#34;test&#34;} }
{ &#34;doc&#34; : {&#34;field2&#34; : &#34;value2&#34;} }
</code></pre><p>每一个操作都会返回对应的结果</p><pre tabindex=0><code>{
  &#34;took&#34; : 7,
  &#34;errors&#34; : false,
  &#34;items&#34; : [
    {
      &#34;index&#34; : {
        &#34;_index&#34; : &#34;test&#34;,
        &#34;_type&#34; : &#34;_doc&#34;,
        &#34;_id&#34; : &#34;1&#34;,
        &#34;_version&#34; : 6,
        &#34;result&#34; : &#34;created&#34;,
        &#34;_shards&#34; : {
          &#34;total&#34; : 2,
          &#34;successful&#34; : 1,
          &#34;failed&#34; : 0
        },
        &#34;_seq_no&#34; : 10,
        &#34;_primary_term&#34; : 1,
        &#34;status&#34; : 201
      }
    },
    {
      &#34;delete&#34; : {
        &#34;_index&#34; : &#34;test&#34;,
        &#34;_type&#34; : &#34;_doc&#34;,
        &#34;_id&#34; : &#34;2&#34;,
        &#34;_version&#34; : 3,
        &#34;result&#34; : &#34;not_found&#34;,
        &#34;_shards&#34; : {
          &#34;total&#34; : 2,
          &#34;successful&#34; : 1,
          &#34;failed&#34; : 0
        },
        &#34;_seq_no&#34; : 11,
        &#34;_primary_term&#34; : 1,
        &#34;status&#34; : 404
      }
    },
    {
      &#34;create&#34; : {
        &#34;_index&#34; : &#34;test&#34;,
        &#34;_type&#34; : &#34;_doc&#34;,
        &#34;_id&#34; : &#34;3&#34;,
        &#34;_version&#34; : 3,
        &#34;result&#34; : &#34;created&#34;,
        &#34;_shards&#34; : {
          &#34;total&#34; : 2,
          &#34;successful&#34; : 1,
          &#34;failed&#34; : 0
        },
        &#34;_seq_no&#34; : 12,
        &#34;_primary_term&#34; : 1,
        &#34;status&#34; : 201
      }
    },
    {
      &#34;update&#34; : {
        &#34;_index&#34; : &#34;test&#34;,
        &#34;_type&#34; : &#34;_doc&#34;,
        &#34;_id&#34; : &#34;1&#34;,
        &#34;_version&#34; : 7,
        &#34;result&#34; : &#34;updated&#34;,
        &#34;_shards&#34; : {
          &#34;total&#34; : 2,
          &#34;successful&#34; : 1,
          &#34;failed&#34; : 0
        },
        &#34;_seq_no&#34; : 13,
        &#34;_primary_term&#34; : 1,
        &#34;status&#34; : 200
      }
    }
  ]
}
</code></pre><h2 id=mget-批量获取>mget 批量获取</h2><pre tabindex=0><code># 批量获取 mget
GET /_mget 
{
  &#34;docs&#34;:[
    {
      &#34;_index&#34;:&#34;test&#34;,
      &#34;_id&#34;:&#34;1&#34;
    },
    {
      &#34;_index&#34;:&#34;test&#34;,
      &#34;_id&#34;:&#34;3&#34;
    }
  ]
}
简单写法
GET /student/_mget
{
  &#34;ids&#34;:[1,2,3]
}
</code></pre><p>对应的返回每一条结果</p><pre tabindex=0><code>{
  &#34;docs&#34; : [
    {
      &#34;_index&#34; : &#34;test&#34;,
      &#34;_type&#34; : &#34;_doc&#34;,
      &#34;_id&#34; : &#34;1&#34;,
      &#34;_version&#34; : 7,
      &#34;_seq_no&#34; : 13,
      &#34;_primary_term&#34; : 1,
      &#34;found&#34; : true,
      &#34;_source&#34; : {
        &#34;field1&#34; : &#34;value1&#34;,
        &#34;field2&#34; : &#34;value2&#34;
      }
    },
    {
      &#34;_index&#34; : &#34;test&#34;,
      &#34;_type&#34; : &#34;_doc&#34;,
      &#34;_id&#34; : &#34;3&#34;,
      &#34;_version&#34; : 3,
      &#34;_seq_no&#34; : 12,
      &#34;_primary_term&#34; : 1,
      &#34;found&#34; : true,
      &#34;_source&#34; : {
        &#34;field1&#34; : &#34;value3&#34;
      }
    }
  ]
}
</code></pre><h2 id=msearch-批量搜索>msearch 批量搜索</h2><pre tabindex=0><code>POST /student/_msearch
{}
{&#34;query&#34;:{&#34;match_all&#34;:{}}, &#34;size&#34;:1}
</code></pre><h2 id=查询>查询</h2><h3 id=分词使用>分词使用</h3><p>官方提供标准的分词器, 对于亚洲语言, 可以安装</p><pre tabindex=0><code>bin/elasticsearch-plugin list # 查看安装过的插件
bin/elasticsearch-plugin install analysis-icu # 安装icu, 支持亚洲语言的插件
# 更好的支持中文, 使用 ik
https://github.com/medcl/elasticsearch-analysis-ik/releases 
选择 zip包 , 解压安装
</code></pre><pre tabindex=0><code>GET _analyze
{
   &#34;analyzer&#34;: &#34;standard&#34;, # 使用指定的分词器. 或者 icu_analyzer
   &#34;text&#34;:&#34;10.A date math index name takes the following form:分词器哦&#34;
}
</code></pre><h3 id=uri-方式查询>URI 方式查询</h3><blockquote><p>profile:&ldquo;true"查看查询详情过程</p></blockquote><ol><li>df=name 指定某个字段</li><li>sort=name 指定字段排序<ol><li>sort=name:desc</li></ol></li><li>from=0 从什么位置开始</li><li>size=10 返回多少条</li><li>timeout=1s 设置查询超时</li></ol><pre tabindex=0><code># 对所有的字段进行查询
GET /student/_search?q=诗
# 指定某个字段进行查询
GET /student/_search?q=诗&amp;df=name

# profile:&#34;true&#34;查看查询详情过程 
GET /student/_search?q=诗
{
	&#34;profile&#34;:&#34;true&#34;
}

# 可以使用q=字段:值 简单的写法
GET /student/_search?q=name:诗
{
  &#34;profile&#34;: &#34;true&#34;
}
</code></pre><p>搜索字段加引号与不加引号的区别</p><ol><li>name:诗人．　会出现以下三种情况搜索, 相当于: &ldquo;诗&rdquo; or &ldquo;人&rdquo;<ol><li>name:诗 name:人</li><li>name:诗</li><li>name:人</li><li>搜索类型: BooleanQuery, TermQuery</li></ol></li><li>name:诗 人 #中间有个空格<ol><li>不再是指定字段查询啦, 而是泛查询, 对所有字段查询</li><li>搜索类型: BooleanQuery, TermQuery, DisjunctionMaxQuery</li></ol></li><li>name:&ldquo;诗人&rdquo;<ol><li>只有一种情况: name:&ldquo;诗人&rdquo;, 一个整体查询, 前后保持一致</li><li>搜索类型: PhraseQuery</li></ol></li></ol><pre tabindex=0><code>GET /student/_search?q=name:诗人
{
  &#34;profile&#34;: &#34;true&#34;
}

GET /student/_search?q=name:诗 人
{
  &#34;profile&#34;: &#34;true&#34;
}

GET /student/_search?q=name:&#34;诗人&#34;
{
  &#34;profile&#34;: &#34;true&#34;
}
</code></pre><h4 id=布尔操作>布尔操作</h4><p>​ AND/OR/NOT &&/ || / !</p><pre tabindex=0><code># 采用 BooleanQuery 操作. 
# &#34;description&#34; : &#34;name:诗 name:and name:人&#34;,
GET /student/_search?q=name:(诗 and 人)
{
  &#34;profile&#34;: &#34;true&#34;
}
</code></pre><h4 id=分组>分组</h4><pre><code>  	1. `+` 表示 must
  	2. `-` 表示 must_not
</code></pre><h3 id=request-body-查询>Request Body 查询</h3><pre tabindex=0><code>GET /student/_search
{
  &#34;_source&#34;: [&#34;name&#34;], # 指定返回的字段.
  &#34;from&#34;:0, # 开始的位置
  &#34;size&#34;: 2, # 返回的尺寸大小
  &#34;query&#34;: { # 查询
    &#34;match_all&#34;: {} # 查询所有
  }
}
</code></pre><p>脚本字段</p><pre tabindex=0><code></code></pre><h4 id=指定某字段查询>指定某字段查询</h4><pre tabindex=0><code># 不加操作类型, 默认为 or 
GET /student/_search
{
  &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;name&#34;: &#34;李白 诗人&#34;
    }
  }
}
# 指定操作类型, operator:and
GET /student/_search
{
  &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;name&#34;: {
        &#34;query&#34;: &#34;诗人&#34;
        , &#34;operator&#34;: &#34;and&#34;
      }
    }
  }
}
</code></pre><h4 id=进行整体查询>进行整体查询</h4><pre tabindex=0><code>
# 整体查询, 前后一致
GET /student/_search
{
  &#34;query&#34;: {
    &#34;match_phrase&#34;: {
      &#34;name&#34;: {
        &#34;query&#34;: &#34;诗人&#34;
      }
    }
  }
}
# 如果加上slop 中间可以插入别的字也匹配
GET /student/_search
{
  &#34;query&#34;: {
    &#34;match_phrase&#34;: {
      &#34;name&#34;: {
        &#34;query&#34;: &#34;诗人&#34;,
        &#34;slop&#34;: 1
      }
    }
  }
}
</code></pre><h4 id=query_string-查询方法>query_string 查询方法</h4><pre tabindex=0><code># 使用 query_string 查询

POST /student/_search
{
  &#34;query&#34;: {
    &#34;query_string&#34;: {
      &#34;default_field&#34;: &#34;name&#34;,
      &#34;query&#34;: &#34;诗 AND 人&#34;
    }
  }
}

POST /student/_search
{
  &#34;query&#34;: {
    &#34;query_string&#34;: {
      &#34;default_field&#34;: &#34;name&#34;,
      &#34;query&#34;: &#34;诗 OR 人&#34;
    }
  }
}
# 过滤一些错误的语法
POST /student/_search
{
  &#34;query&#34;: {
    &#34;simple_query_string&#34;: {
      &#34;query&#34;: &#34;诗 AND 人 OR 190&#34;,
      &#34;fields&#34;: [&#34;name&#34;]
    }
  }
}
</code></pre><h2 id=高级查询>高级查询</h2><h3 id=指定返回字段>指定返回字段</h3><pre tabindex=0><code>GET /student/_search
{
   &#34;_source&#34;: [&#34;name&#34;, &#34;age&#34;],
   &#34;from&#34;: 0
}
</code></pre><h3 id=聚合查询>聚合查询</h3><p>max, min, avg 最大, 最小, 平均值.</p><p>age_avg, age_max, age_min 是自定义的字段名称.</p><pre tabindex=0><code>GET /student/_search
{
  &#34;size&#34;:0,
  &#34;aggs&#34;: {
    &#34;age_avg&#34;: {
      &#34;avg&#34;: { 
        &#34;field&#34;: &#34;age&#34;
      }
    },
    &#34;age_max&#34;:{
      &#34;max&#34;: {
        &#34;field&#34;: &#34;age&#34;
      }
    },
    &#34;age_min&#34;:{
      &#34;min&#34;: {
        &#34;field&#34;: &#34;age&#34;
      }
    }
  }
}
</code></pre><h3 id=嵌套查询聚合>嵌套查询聚合</h3><p>aggs , terms 按bucker统计, 再在当前bucker里再求avg和stat</p><pre tabindex=0><code>GET /student/_search
{
  &#34;size&#34;:0,
  &#34;aggs&#34;: {
    &#34;age_aggs&#34;: {
      &#34;terms&#34;: {
        &#34;field&#34;: &#34;age&#34;,
        &#34;size&#34;: 10
      },
      &#34;aggs&#34;: {
        &#34;age_avg&#34;: {
          &#34;avg&#34;: {
            &#34;field&#34;: &#34;age&#34;
          }
        },
        &#34;stats_age&#34;:{
          &#34;stats&#34;: {
            &#34;field&#34;: &#34;age&#34;
          }
        }
      }
    }
  }
}
</code></pre><h3 id=term-查询>term 查询</h3><p>term 查询对输入不做分词, 会将输入作为一个整体.</p><p>插入新数据</p><pre tabindex=0><code>POST /products/_bulk
{&#34;index&#34;:{&#34;_id&#34;:1}}
{&#34;productID&#34;:&#34;a2020-kk-#001&#34;, &#34;desc&#34;:&#34;iPhone&#34;}
{&#34;index&#34;:{&#34;_id&#34;:2}}
{&#34;productID&#34;:&#34;a2020-kk-#002&#34;, &#34;desc&#34;:&#34;iPad&#34;}
{&#34;index&#34;:{&#34;_id&#34;:3}}
{&#34;productID&#34;:&#34;a2020-kk-#003&#34;, &#34;desc&#34;:&#34;MP3&#34;}
</code></pre><pre tabindex=0><code># 直接搜索无法找到, 因为es在做 index 时会做一个分词处理. 
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;, 
  &#34;query&#34;: {
    &#34;term&#34;: {
      &#34;desc&#34;: {
        &#34;value&#34;: &#34;iPhone&#34;
      }
    }
  }
}
</code></pre><pre tabindex=0><code># 使用小写进行查询, 能查询到.
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;, 
  &#34;query&#34;: {
    &#34;term&#34;: {
      &#34;desc&#34;: {
        &#34;value&#34;: &#34;iphone&#34;
      }
    }
  }
}
</code></pre><pre tabindex=0><code># 或者 使用 keyword
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;, 
  &#34;query&#34;: {
    &#34;term&#34;: {
      &#34;desc.keyword&#34;: {
        &#34;value&#34;: &#34;iPhone&#34;
      }
    }
  }
}
</code></pre><pre tabindex=0><code># 以下查询并不会查询到任何结果, 因为index时对 prodoctID 进行了分词操作.
POST /products/_search
{
  &#34;query&#34;: {
    &#34;term&#34;: {
      &#34;productID&#34;: {
        &#34;value&#34;: &#34;a2020-kk-#003&#34;
      }
    }
  }
}
# 上面查询不到,等价于以下标准分词

GET _analyze
{
  &#34;analyzer&#34;: &#34;standard&#34;,
  &#34;text&#34;: [&#34;a2020-kk-#003&#34;]
}
</code></pre><pre tabindex=0><code># 以上可以使用 keyword 解决

POST /products/_search
{
  &#34;query&#34;: {
    &#34;term&#34;: {
      &#34;productID.keyword&#34;: {
        &#34;value&#34;: &#34;a2020-kk-#003&#34;
      }
    }
  }
}
</code></pre><h3 id=复合查询>复合查询</h3><p>复合查询, Constant Score 转为 Filter</p><p>避免相关性的算分开销, 利用 Filter 缓存提高查询效率</p><pre tabindex=0><code>POST /products/_search
{
  &#34;explain&#34;: true,
  &#34;query&#34;: {
    &#34;constant_score&#34;: {
      &#34;filter&#34;: {
        &#34;term&#34;: {
          &#34;productID.keyword&#34;: &#34;a2020-kk-#003&#34;
        }
      },
      &#34;boost&#34;: 1
    }
  }
}
</code></pre><pre tabindex=0><code># 全文本查询

# 以下查询是一种全文查询, 会采用 or 
# 将&#34;kk 003&#34; 切分成&#34;kk&#34; or &#34;003&#34; 
# 也就是说只要包括 kk 或 003的都返回.
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;
  , &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;productID&#34;: &#34;kk 003&#34;
    }
  }
}
</code></pre><pre tabindex=0><code>
# 以下是添加额外条件查询. 采用 and. 必须全都出现.
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;
  , &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;productID&#34;: {
        &#34;query&#34;: &#34;kk 003&#34;
        , &#34;operator&#34;: &#34;and&#34;
      }
    }
  }
}
</code></pre><p>minimum_should_match 的使用</p><p>意思是最小匹配一个</p><pre tabindex=0><code># 设定最小匹配数量
POST /products/_search
{
  &#34;profile&#34;: &#34;true&#34;, 
  &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;productID&#34;: {
        &#34;query&#34;: &#34;a2020 003&#34;,
        &#34;minimum_should_match&#34;: 1
      }
    }
  }
}
</code></pre><h3 id=范围查询>范围查询</h3><h4 id=数字-range-查询>数字 range 查询</h4><pre tabindex=0><code># 数字 range 查询
POST products/_search
{
  &#34;query&#34;: {
    &#34;constant_score&#34;: {
      &#34;filter&#34;: {
        &#34;range&#34;: {
          &#34;price&#34;: {
            &#34;gte&#34;: 20,
            &#34;lte&#34;: 30
          }
        }
      }
      ,&#34;boost&#34;: 1.2
    }
  }
}
</code></pre><h4 id=日期-range>日期 range</h4><pre tabindex=0><code># 日期 range
# now-ly 当前时间减去1年, 相当于去年的数据. gte 就是大于2019年的数据, 全返回
# y 年, M 月, w 周, d 天, H/h 小时, m 分钟, s秒
POST products/_search
{
  &#34;query&#34;: {
    &#34;constant_score&#34;: {
      &#34;filter&#34;: {
        &#34;range&#34;: {
          &#34;date&#34;: {
            &#34;gte&#34;: &#34;now-1y&#34;
          }
        }
      },
      &#34;boost&#34;: 1.2
    }
  }
}
</code></pre><h3 id=字段存在否>字段存在否</h3><pre tabindex=0><code># exists 查找只包含这个字段的数据.
POST products/_search
{
  &#34;query&#34;: {
    &#34;constant_score&#34;: {
      &#34;filter&#34;: {
        &#34;exists&#34;: {
          &#34;field&#34;: &#34;date&#34;
        }
      },
      &#34;boost&#34;: 1.2
    }
  }
}
</code></pre><h2 id=bool-查询>BOOL 查询</h2><ol><li>must 算分</li><li>must_not 算分</li><li>filter 不算分</li><li>shoud 算分</li></ol><p>新增一下数据</p><pre tabindex=0><code>POST /news/_bulk
{&#34;index&#34;:{&#34;_id&#34;:1}}
{&#34;content&#34;:&#34;Apple Mac&#34;}
{&#34;index&#34;:{&#34;_id&#34;:2}}
{&#34;content&#34;:&#34;Apple Ipad&#34;}
{&#34;index&#34;:{&#34;_id&#34;:3}}
{&#34;content&#34;:&#34;Apple employee like Apple Pie and Apple Juice&#34;}
</code></pre><h4 id=单个must>单个must</h4><pre tabindex=0><code># 普通搜索, 只要含有apple的文本就返回
POST news/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        {
          &#34;match&#34;: {
            &#34;content&#34;: &#34;apple&#34;
          }
        }
      ]
    }
  }
}
</code></pre><h4 id=must-must_not组合>must, must_not组合</h4><pre tabindex=0><code># 要求只返回与苹果公司相关产品的信息, 过滤吃苹果汁的信息
POST news/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        {
          &#34;match&#34;: {
            &#34;content&#34;: &#34;apple&#34;
          }
        }
      ],
      &#34;must_not&#34;: [
        {
          &#34;match&#34;: {
            &#34;content&#34;: &#34;pie&#34;
          }
        }
      ]
    }
  }
}
</code></pre><h4 id=对顺序调整-分值>对顺序调整, 分值</h4><pre tabindex=0><code>
# 我们要求把苹果公司的信息显示最上面, 吃苹果的信息也显示, 显示在最下面.
# 就可以使用算分来控制
# positive 正面的, 加分
# negative 负面的, 减分
POST news/_search
{
  &#34;query&#34;: {
    &#34;boosting&#34;: {
      &#34;positive&#34;: {
        &#34;match&#34;: {
          &#34;content&#34;: &#34;apple&#34;
        }
      },
      &#34;negative&#34;: {
        &#34;match&#34;: {
          &#34;content&#34;: &#34;pie&#34;
        }
      },
      &#34;negative_boost&#34;: 0.2
    }
  }
}
</code></pre><pre tabindex=0><code># must 算分, must_not 算分, filter不算分,shoud算分

POST move/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        {
          &#34;term&#34;: {
            &#34;genere.keyword&#34;: {
              &#34;value&#34;: &#34;jack&#34;
            }
          }
        },
        {
          &#34;term&#34;: {
            &#34;genere_count&#34;: {
              &#34;value&#34;: 2
            }
          }
        }
      ]
    }
  }
}
</code></pre><h2 id=自定义分词器>自定义分词器</h2><pre tabindex=0><code># 自定义分词器
DELETE my_index
PUT my_index
{
  &#34;settings&#34;: {
    &#34;analysis&#34;: {
      &#34;analyzer&#34;: {
        &#34;my_custom_analyzer&#34;:{
          &#34;type&#34;:&#34;custom&#34;,
          &#34;char_filter&#34;:[&#34;emoticons&#34;],
          &#34;tokenizer&#34;:&#34;punctuation&#34;,
          &#34;filter&#34;:[&#34;lowercase&#34;, &#34;english_stop&#34;]
        }
      },
      &#34;tokenizer&#34;: {
        &#34;punctuation&#34;:{
          &#34;type&#34;:&#34;pattern&#34;,
          &#34;pattern&#34;:&#34;[ .,!?]&#34;
        }
      },
      &#34;char_filter&#34;: {
        &#34;emoticons&#34;:{
          &#34;type&#34;:&#34;mapping&#34;,
          &#34;mappings&#34;:[
            &#34;:) =&gt; _happy_&#34;
            ]
        }
      },
      &#34;filter&#34;: {
        &#34;english_stop&#34;:{
          &#34;type&#34;:&#34;stop&#34;,
          &#34;stopwords&#34;:&#34;_english_&#34;
        }
      }
    }
  }
}
</code></pre><p>使用自定义分词器</p><pre tabindex=0><code>POST my_index/_analyze
{
  &#34;analyzer&#34;: &#34;my_custom_analyzer&#34;,
  &#34;text&#34;: [&#34;:) person man, HELLO&#34;]
}
</code></pre><h2 id=设置-mappings--settings>设置 mappings & settings</h2><pre tabindex=0><code>PUT index
{
  &#34;settings&#34;: {
    &#34;number_of_shards&#34;: 3,
    &#34;number_of_replicas&#34;: 1,
    &#34;analysis&#34;: {
      &#34;analyzer&#34;: {
        &#34;ik&#34;: {
          &#34;tokenizer&#34;: &#34;ik_max_word&#34;
        }
      }
    }
  },
  &#34;mappings&#34;: {
    &#34;test1&#34;:{
      &#34;properties&#34;: {
        &#34;content&#34;: {
          &#34;type&#34;: &#34;text&#34;,
          &#34;analyzer&#34;: &#34;ik&#34;,
          &#34;search_analyzer&#34;: &#34;ik_max_word&#34;
        }
      }
    }
  }
}
————————————————
版权声明：本文为CSDN博主「gxx_csdn」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/gxx_csdn/article/details/79110384
</code></pre><h2 id=常见错误>常见错误</h2><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20200723154626.png?imageslim alt></p><h2 id=推荐阅读>推荐阅读</h2><ol><li><a href=https://yezihack.github.io/es-info.html target=_blank>Elasticsearch 入门(一) 介绍</a></li><li><a href=https://yezihack.github.io/es-install.html target=_blank>Elasticsearch 入门(二) 安装</a></li><li><a href=https://yezihack.github.io/es-head.html target=_blank>Elasticsearch 入门(三) Head 助手安装</a></li><li><a href=https://yezihack.github.io/es-search.html target=_blank>Elasticsearch 入门(四) 查询</a></li></ol><h2 id=参考>参考</h2><p>1.<a href=http://www.ruanyifeng.com/blog/2017/08/elasticsearch.html target=_blank>全文搜索引擎 Elasticsearch 入门教程</a></p><hr><div class=footer><a class=previous-post href="https://yezihack.github.io/posts/redis-config/?ref=footer"><span style=font-weight:700>« Previous</span><br>Redis 配置</a><div class=next-post><a href="https://yezihack.github.io/posts/es-info/?ref=footer"><span style=font-weight:700>Next »</span><br>Elasticsearch 入门(一) 介绍</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#简介>简介</a></li><li><a href=#基本restful操作>基本RESTful操作</a><ul><li><a href=#新增记录-create>新增记录 create</a></li><li><a href=#获取文档-get>获取文档 get</a></li><li><a href=#更新文档-update>更新文档 update</a></li><li><a href=#删除文档-delete>删除文档 delete</a></li></ul></li><li><a href=#bulk-批量操作>bulk 批量操作</a></li><li><a href=#mget-批量获取>mget 批量获取</a></li><li><a href=#msearch-批量搜索>msearch 批量搜索</a></li><li><a href=#查询>查询</a><ul><li><a href=#分词使用>分词使用</a></li><li><a href=#uri-方式查询>URI 方式查询</a></li><li><a href=#request-body-查询>Request Body 查询</a></li></ul></li><li><a href=#高级查询>高级查询</a><ul><li><a href=#指定返回字段>指定返回字段</a></li><li><a href=#聚合查询>聚合查询</a></li><li><a href=#嵌套查询聚合>嵌套查询聚合</a></li><li><a href=#term-查询>term 查询</a></li><li><a href=#复合查询>复合查询</a></li><li><a href=#范围查询>范围查询</a></li><li><a href=#字段存在否>字段存在否</a></li></ul></li><li><a href=#bool-查询>BOOL 查询</a><ul><li></li></ul></li><li><a href=#自定义分词器>自定义分词器</a></li><li><a href=#设置-mappings--settings>设置 mappings & settings</a></li><li><a href=#常见错误>常见错误</a></li><li><a href=#推荐阅读>推荐阅读</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></body></html>