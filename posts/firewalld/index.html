<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.14549c76bbc96f0af1574b0259efd70e52908cd36fb4d14ed3d290a1b6479eae.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/p2.png><title itemprop=name>空树之空 - Linux Firewalld 极简教程</title><meta property="og:title" content="空树之空 - Linux Firewalld 极简教程"><meta name=twitter:title content="空树之空 - Linux Firewalld 极简教程"><meta itemprop=name content="空树之空 - Linux Firewalld 极简教程"><meta name=application-name content="空树之空 - Linux Firewalld 极简教程"><meta property="og:site_name" content="空树之空"><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://yezihack.github.io/posts/firewalld/><link rel=canonical href=https://yezihack.github.io/posts/firewalld/ itemprop=url><meta name=url content="https://yezihack.github.io/posts/firewalld/"><meta name=twitter:url content="https://yezihack.github.io/posts/firewalld/"><meta property="og:url" content="https://yezihack.github.io/posts/firewalld/"><meta property="og:updated_time" content="31001-31-10T144:25:24+0800"><link rel=sitemap type=application/xml title=Sitemap href=https://yezihack.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content="空树之空"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="29012-29-03T1244:25:23+0800"><meta property="article:published_time" content="29012-29-03T1244:25:23+0800"><meta property="og:article:author" content="百里"><meta property="article:author" content="百里"><meta name=author content="百里"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Linux Firewalld 极简教程","author":{"@type":"Person","name":""},"datePublished":"2023-12-29","description":"","wordCount":"1070","mainEntityOfPage":"True","dateModified":"2024-01-31","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"空树之空","logo":{"@type":"imageObject","url":"\/images\/p2.png"}}}</script><meta name=generator content="Hugo 0.114.0"><link type=text/css rel=stylesheet href=/css/bundle.min.aa949ea27ee9836d60d6ea4c073fd0885f51948c7eea0247da6b1aff4bc25c44.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body class=dark-theme><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://yezihack.github.io/><img src=/images/logo_transparent.png alt="brand image"></a>
<a href=https://yezihack.github.io/><h1>空树之空</h1></a></h1><p class=lead>《空樹之空》博客是一个技术导向的平台，聚焦于Kubernetes、DevOps和Linux等领域。通过简洁而优美的文字，我们提供对这些技术主题的深入探索和实用的指南。</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://yezihack.github.io/posts/linux-ssh-agent/>Linux ssh-agent 极简教程</a></li><li class=bullet><a href=https://yezihack.github.io/posts/linux-ccze/>Linux Ccze 彩色化日志文件输出的工具</a></li><li class=bullet><a href=https://yezihack.github.io/posts/wsl-install/>Windows 子系统 Linux 系统之 WSL2 安装</a></li><li class=bullet><a href=https://yezihack.github.io/posts/firewalld/>Linux Firewalld 极简教程</a></li><li class=bullet><a href=https://yezihack.github.io/posts/chronyd/>Linux Chronyd 极简教程</a></li><li class=heading><a href=/tags/>Tags</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=https://yezihack.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote><br>&copy; 2024 百里江山. All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://yezihack.github.io/posts/firewalld/>Linux Firewalld 极简教程</a></h1><time datetime=2023-12-29T15:44:25+0800 class=post-date>December 29, 2023</time><ul class=tags><li class=tag-linux><a href=https://yezihack.github.io/tags/linux>linux</a></li><li class=tag-firewalld><a href=https://yezihack.github.io/tags/firewalld>firewalld</a></li><li class=tag-极简教程><a href=https://yezihack.github.io/tags/%E6%9E%81%E7%AE%80%E6%95%99%E7%A8%8B>极简教程</a></li></ul></div><h2 id=1-什么是-firewalld>.1. 什么是 Firewalld</h2><p>Firewalld 是一个在 Linux 系统上提供动态防火墙管理的工具。它是一个用户和管理员友好的前端，用于配置和管理 iptables 规则，并提供了一种简化的方式来管理网络连接和保护系统免受未经授权的访问。</p><p>Firewalld 的主要特点包括：</p><ol><li>基于区域的防火墙：Firewalld 将网络接口划分为不同的区域，例如公共区域、内部区域和信任区域。每个区域都有其自己的安全策略和规则集。</li><li>动态更新规则：Firewalld 允许实时添加、删除和修改防火墙规则，而无需重启防火墙服务或中断网络连接。</li><li>服务和应用程序级别的访问控制：Firewalld 允许根据服务或应用程序的名称来控制网络访问权限，而不仅仅是基于端口号。</li><li>高级网络管理功能：Firewalld 支持网络地址转换（NAT）、端口转发、IPSec 和 IPv6 等高级网络功能。</li><li>兼容性和扩展性：Firewalld 可以与其他网络管理工具和服务集成，如 NetworkManager 和 SELinux。</li></ol><p>使用 Firewalld，管理员可以轻松地配置和管理系统的防火墙设置，保护系统免受恶意网络活动和未经授权的访问。它提供了一种灵活且强大的方式来管理网络连接，并根据实际需求进行定制配置。</p><p>需要注意的是，Firewalld 本身并不是防火墙，而是一个防火墙管理工具。</p><h2 id=2-工作原理>.2. 工作原理</h2><p>Firewalld 的工作原理可以简要概括如下：</p><ol><li><p>区域和服务定义：Firewalld 使用预定义的区域和服务来管理网络连接和访问控制。区域定义了特定接口的安全策略，而服务定义了允许的网络服务和端口。</p></li><li><p>运行时状态：Firewalld 在运行时维护一个状态，以跟踪网络连接和防火墙规则的变化。它监视网络接口上的数据包流量，并根据规则进行决策。</p></li><li><p>防火墙规则集：Firewalld 根据配置文件中定义的防火墙规则集来处理传入和传出的数据包。规则可以基于源 IP、目标 IP、源端口、目标端口等条件进行匹配，并决定是允许还是拒绝数据包。</p></li><li><p>动态更新：Firewalld 允许在运行时动态地添加、删除和修改防火墙规则，而无需重启防火墙服务或中断网络连接。这使得管理员可以实时地对网络连接进行调整和控制。</p></li><li><p>网络地址转换（NAT）和端口转发：Firewalld 支持配置网络地址转换（NAT）和端口转发规则，以便将数据包从一个网络接口转发到另一个接口或端口。</p></li><li><p>D-Bus 接口：Firewalld 提供了一个 D-Bus 接口，使其他应用程序和工具可以与其交互并管理防火墙设置。</p></li><li><p>Firewalld 是通过定义防火墙规则最终交由内核的 netfilter 进行包过滤实现防火墙功能。</p></li></ol><h2 id=3-架构图>.3. 架构图</h2><p>以下是官方给出的架构图，<a href=https://firewalld.org/documentation/architecture.html target=_blank>https://firewalld.org/documentation/architecture.html</a></p><p><img src=https://firewalld.org/documentation/firewalld-structure+nftables.png alt></p><p>Firewalld 是一个复杂的系统，包含了多个组件和模块来实现其功能。以下是关于每个组件的简要介绍：</p><ol><li><p>前端组件：</p><ul><li>firewall-cmd：firewall-cmd 是 Firewalld 的命令行前端工具，用于管理和配置防火墙规则、区域、服务等。</li><li>firewall-config：firewall-config 是一个图形化的前端工具，提供了一个易于使用的界面来配置和管理防火墙设置。</li><li>firewall-applet：firewall-applet 是 Firewalld 的系统托盘应用程序，可以在系统托盘中显示防火墙状态，并提供快速访问配置选项的功能。</li><li>firewall-offline-cmd：firewall-offline-cmd 是一个离线命令行工具，用于在没有网络连接的情况下配置和管理防火墙规则。</li></ul></li><li><p>核心组件：</p><ul><li>Zone（区域）：Zone 定义了特定接口的安全策略和防火墙规则集，例如内部区域、公共区域、信任区域等。</li><li>IPSet（IP集合）：IPSet 是一种高效的数据结构，用于存储和管理 IP 地址和网络地址的集合，可用于更精细地定义防火墙规则。</li><li>Service（服务）：Service 定义了特定应用程序或服务的网络连接规则和端口范围，例如 HTTP、SSH 等。</li><li>Icmptype（ICMP 类型）：Icmptype 定义了 ICMP（Internet 控制消息协议）的类型和代码，用于控制对 ICMP 数据包的处理。</li><li>Helper（协议助手）：Helper 提供了一种方式来跟踪和处理特定应用程序或协议相关的网络连接，例如 FTP、SIP 等。</li><li>Direct（直接规则）：Direct 允许管理员直接定义自定义防火墙规则，以满足特定需求。</li><li>Policy（策略）：Policy 用于配置和管理防火墙的默认策略，例如默认拒绝或默认允许。</li></ul></li><li><p>后端组件：</p><ul><li>NetworkManager：NetworkManager 是一个后端插件，用于与 NetworkManager 网络管理器集成，以获取网络接口和连接的状态信息。</li><li>iptables、ip6tables：iptables 和 ip6tables 是 Linux 系统的防火墙工具，Firewalld 使用它们来实际操作防火墙规则。</li><li>nft：nft 是一个新一代的防火墙工具，用于进行高级网络过滤和转发操作。</li><li>modules：Modules 提供了扩展功能和插件，用于支持额外的防火墙功能和特性，如网络地址转换（NAT）、端口转发等。</li><li>ipset：ipset 是一个工具集，用于管理 IP 集合，并可以与防火墙规则集成。</li><li>ebtables：ebtables 是一个工具集，用于处理以太网帧层的防火墙规则和过滤器。</li><li>libnftables：libnftables 是一个库，提供了程序化配置和管理 nftables 的接口。</li></ul></li><li><p>内核组件：</p><ul><li>Kernel（kmod）：Kernel 模块是 Linux 内核的一部分，用于支持网络过滤和转发功能，提供底层的防火墙支持。</li><li>Kernel（netfilter）：Netfilter 是 Linux 内核中的一个框架，用于实现网络数据包的过滤、转发和修改操作。</li></ul></li></ol><p>这些组件共同协作，使 Firewalld 能够提供动态防火墙管理和配置的功能，并为系统提供强大的网络安全保护。</p><h2 id=4-安装>.4. 安装</h2><p>在 CentOS7 默认使用 firewalld 作为防火墙</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>yum -y install firewalld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开启防火墙</span>
</span></span><span style=display:flex><span>systemctl start firewalld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加入开机启动</span>
</span></span><span style=display:flex><span>systemctl enable firewalld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行状态， running（运行中）not running（未运行）</span>
</span></span><span style=display:flex><span>firewall-cmd --state
</span></span></code></pre></div><h2 id=5-firewalld-区域管理>.5. Firewalld 区域管理</h2><p>通过将网络划分成不同的区域，制定出不同区域之间的访问控制策略来控制不同程序区域间传送的数据流。</p><table><thead><tr><th>网络区名称</th><th>默认配置</th></tr></thead><tbody><tr><td>trusted（信任）</td><td>可接受所有的网络连接</td></tr><tr><td>home（家庭）</td><td>用于家庭网络，仅接受ssh,mdns,gp-client,samba-client,dhcpv6-client连接</td></tr><tr><td>internal（ 内部）</td><td>用于内部网络，仅接受ssh,mdns,gp-client,samba-client,dhcpv6-client连接</td></tr><tr><td>work（工作）</td><td>用于工作区，仅接受sshjpp-client,dhcpv6-client服务连接</td></tr><tr><td>public（工作）</td><td>用于工作区，仅接受ssh,ipp-client,dhcpv6-client服务连接，在公共区域内使用，仅接受ssh或dhcpv6-client服务连接，是firewalld的默认区域</td></tr><tr><td>external（ 外部）</td><td>出去的ipv4网络连接通过此区域为伪装或转发，仅接受ssh服务的连接</td></tr><tr><td>dmz（非军事区）</td><td>仅接受ssh服务的连接</td></tr><tr><td>block（限制）</td><td>拒绝所有网络的连接</td></tr><tr><td>drop （丢弃）</td><td>任何接收的网络数据包都被丢弃，没有任何回复</td></tr></tbody></table><h3 id=51-firewalld-区域的指导>.5.1. firewalld 区域的指导</h3><ol><li>默认区域：默认情况下，系统中的所有接口都会被分配到默认区域。你可以通过修改默认区域的规则来控制网络流量的访问。<ol><li>如设置 public 为默认区域，则 interfaces 未分配接口时，接管所有的接口流量。</li><li>如设置 public interfaces 接口为 eth0,则只接管 eth0 接口的流量。</li></ol></li><li>活跃区域：如果某区域设置了某接口则表示这个区域正在活跃，则表示这个区域的规则是对这个接口生效的。<ol><li>如果某区域标有（active）字样则也表示活跃状态，则该区域的规则也生效。</li></ol></li><li>区域划分：你可以根据你的网络环境和需求创建自定义区域，通过将不同的接口分配给不同的区域，你可以根据需要设置不同的防火墙规则，以保护和控制这些不同部分的网络流量。</li><li>防火墙规则：每个区域都可以有自己的一组防火墙规则。</li><li>区域之间的转换：你可以在不同的区域之间移动接口。</li><li>其它<ol><li>如果非默认区域，没有标（active）字样且 interfaces 为空，该区域的规则不生效。</li><li>如果某区域设置 Default 默认区域则规则生效。</li><li>如果非默认区域且设置某接口，规则也对该接口生效。</li></ol></li></ol><h3 id=52-区域管理命令>.5.2. 区域管理命令</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查看可用的区域</span>
</span></span><span style=display:flex><span>firewall-cmd --list-all-zones
</span></span><span style=display:flex><span>firewall-cmd --get-zones
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建区域</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --new-zone<span style=color:#f92672>=</span>&lt;zone&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置默认区域</span>
</span></span><span style=display:flex><span>firewall-cmd --set-default-zone<span style=color:#f92672>=</span>&lt;zone&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看活跃区域</span>
</span></span><span style=display:flex><span>firewall-cmd --get-active-zones
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 区域绑定接口</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>public --add-interface<span style=color:#f92672>=</span>&lt;interface&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 区域更改接口</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>public --change-interface<span style=color:#f92672>=</span>&lt;interface&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 区域删除接口</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>public --remove-interface<span style=color:#f92672>=</span>&lt;interface&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加/删除服务</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>&lt;zone&gt; --add-service<span style=color:#f92672>=</span>&lt;service&gt;
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>&lt;zone&gt; --remove-service<span style=color:#f92672>=</span>&lt;service&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加/删除端口</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>&lt;zone&gt; --add-port<span style=color:#f92672>=</span>&lt;port&gt;/tcp
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>&lt;zone&gt; --remove-port<span style=color:#f92672>=</span>&lt;port&gt;/tcp
</span></span></code></pre></div><h2 id=6-基本命令>.6. 基本命令</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查看所有的区域</span>
</span></span><span style=display:flex><span>firewall-cmd --list-all-zones
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 要修改默认区域：</span>
</span></span><span style=display:flex><span>firewall-cmd --set-default-zone<span style=color:#f92672>=</span>public
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 firewalld 的默认区域</span>
</span></span><span style=display:flex><span>firewall-cmd --get-default-zone
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看正在活跃的区域</span>
</span></span><span style=display:flex><span>firewall-cmd --get-active-zones
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看默认区域规则 </span>
</span></span><span style=display:flex><span>firewall-cmd --list-all 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看指定的 zone 规则</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>trusted --list-all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看状态</span>
</span></span><span style=display:flex><span>sudo firewall-cmd --state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 direct 直接规则</span>
</span></span><span style=display:flex><span>firewall-cmd --direct --get-all-rules
</span></span></code></pre></div><h2 id=7-实战>.7. 实战</h2><p>Firewalld有规则两种状态</p><ol><li>运行时（runtime)：修改规则马上生效,但是临时生效</li><li>持久配置（permanent）：修改后需要重载才会生效</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent <span style=color:#f92672>[</span>RULE<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><p>一旦使用了 <code>--permanent</code> 会将配置写入到/etc/firewalld/{services,zones}/*.xml对应的文件中，配置完成后一定要 reload，否则只能待防火墙重启后这些配置才能生效。</p><p>Firewalld配置文件:</p><ol><li>/etc/firewalld/{services,zones}/*.xml 优先级最高，<code>--permanent</code> 模式生效的策略会放到这里</li><li>/lib/firewalld/{services,zones}/*.xml 优先级要低些，是一些默认配置，可以当做模板使用</li></ol><h3 id=71-新增区域>.7.1. 新增区域</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --new-zone<span style=color:#f92672>=</span>www
</span></span></code></pre></div><h3 id=72-设置默认区域>.7.2. 设置默认区域</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo firewall-cmd --set-default-zone<span style=color:#f92672>=</span>www
</span></span></code></pre></div><h3 id=73-添加网络接口>.7.3. 添加网络接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --zone<span style=color:#f92672>=</span>www --add-interface<span style=color:#f92672>=</span>eth0 
</span></span></code></pre></div><h3 id=74-添加服务>.7.4. 添加服务</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --zone<span style=color:#f92672>=</span>www --add-service<span style=color:#f92672>=</span>http
</span></span></code></pre></div><h3 id=75-添加端口>.7.5. 添加端口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --zone<span style=color:#f92672>=</span>www --add-port<span style=color:#f92672>=</span>22/tcp 
</span></span></code></pre></div><h3 id=76-转发端口>.7.6. 转发端口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --zone<span style=color:#f92672>=</span>www --add-forward-port<span style=color:#f92672>=</span>port<span style=color:#f92672>=</span>80:proto<span style=color:#f92672>=</span>tcp:toport<span style=color:#f92672>=</span>8080:toaddr<span style=color:#f92672>=</span>192.168.1.100 
</span></span></code></pre></div><h3 id=77-开启网络地址伪装转换>.7.7. 开启网络地址伪装转换</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>www --add-masquerade
</span></span></code></pre></div><h3 id=78-使用-direct>.7.8. 使用 direct</h3><blockquote><p>Direct 规则允许在防火墙中直接添加自定义 Iptables 规则</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 添加</span>
</span></span><span style=display:flex><span>firewall-cmd --direct  --permanent --add-rule ipv4 filter INPUT <span style=color:#ae81ff>0</span> -s 192.168.1.101/32 -m multiport -p tcp --dport <span style=color:#ae81ff>22</span> -m comment --comment ssh -j ACCEPT 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询</span>
</span></span><span style=display:flex><span>firewall-cmd --direct --get-all-rules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除</span>
</span></span><span style=display:flex><span>firewall-cmd --direct --remove-rule &lt;rule&gt;
</span></span></code></pre></div><h2 id=8-rich-规则使用>.8. Rich 规则使用</h2><blockquote><p>使用 rich 规则可以更精确地配置 firewalld 防火墙，以满足特定的需求和安全要求。</p></blockquote><ol><li>rule：rich 规则的基本单位是 rule。它定义了特定的过滤或转发操作。</li><li>family：family 参数用于指定规则的协议族，可以是 &ldquo;ipv4&rdquo; 或 &ldquo;ipv6&rdquo;。</li><li>source and destination：使用 source 和 destination 参数可以限制规则适用的来源和目标地址。</li><li>service：使用 service 参数可以匹配预定义的服务名，例如 &ldquo;http&rdquo;、&ldquo;ssh&rdquo; 等。该参数会根据预定义的服务规则自动匹配端口和协议。</li><li>port：使用 port 参数可以指定端口号。可以指定单个端口或端口范围，例如 &ldquo;80&rdquo; 或 &ldquo;8080-8090&rdquo;。</li><li>protocol：使用 protocol 参数可以指定协议类型，例如 &ldquo;tcp&rdquo;、&ldquo;udp&rdquo; 或 &ldquo;icmp&rdquo;。</li><li>accept and reject：accept 操作表示接受通过规则的流量，而 reject 操作表示拒绝通过规则的流量。</li><li>forward-port：forward-port 是一种特殊的 rich 规则，用于设置端口转发。可以指定源端口、目标端口和目标地址。</li><li>to-port and to-addr：forward-port 规则中的 to-port 参数用于指定转发到的目标端口，而 to-addr 参数用于指定转发到的目标地址。</li></ol><h3 id=81-rich-规则格式>.8.1. rich 规则格式</h3><ul><li>添加规则格式: <code>firewall-cmd [--zone=zone] --add-rich-rule='rule' [--timeout=timeval]</code><ul><li><code>--timeout</code> 默认为秒,单位:s(秒),m(分钟),h(小时)</li></ul></li><li>删除规则格式: <code>firewall-cmd [--zone=zone] --remove-rich-rule='rule'</code></li><li>查询规则是否存在格式:<code>firewall-cmd [--zone=zone] --query-rich-rule='rule'</code><ul><li>返回 yes: 0, no: 1</li></ul></li></ul><h3 id=82-rich-规则结构>.8.2. rich 规则结构</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>rule <span style=color:#f92672>[</span>family<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rule family&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> source <span style=color:#f92672>[</span>NOT<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>address<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>[</span>mac<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mac-address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>[</span>ipset<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ipset&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> destination <span style=color:#f92672>[</span>NOT<span style=color:#f92672>]</span> address<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;address&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> element <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> log <span style=color:#f92672>[</span>prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;prefix text&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>[</span>level<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;log level&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>[</span>limit value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rate/duration&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> audit <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> action <span style=color:#f92672>]</span>
</span></span></code></pre></div><h3 id=83-添加-rich-代码>.8.3. 添加 rich 代码</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 允许 http 服务通行</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source address=&#34;any&#34; service name=&#34;http&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 允许 TCP 22 端口通行</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; port port=&#34;22&#34; protocol=&#34;tcp&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 将 TCP 80 转发到 192.168.1.100 8080 端口上</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; forward-port port=&#34;80&#34; protocol=&#34;tcp&#34; to-port=&#34;8080&#34; to-addr=&#34;192.168.1.100&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只允许 192.168.9.20 8100 端口通行</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source address=&#34;192.168.9.20/32&#34; port port=&#34;8100&#34; protocol=&#34;tcp&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只允许 192.168.9.20 telnet 服务通行</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 source address=192.168.9.20/32 service name=telnet limit value=1/m accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只允许 192.168.9.20 8100 端口通行并限速一分钟内只允许一个连接</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 source address=&#34;192.168.9.20/32&#34; port protocol=&#34;tcp&#34; port=&#34;8100&#34; limit value=1/m accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 禁止 ping </span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule protocol value=icmp reject&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 允许 ping </span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule protocol value=icmp accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 60秒后超时自动删除规则命令,即生效时间为60秒,默认为秒,单位:s(秒),m(分钟),h(小时)</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule protocol value=&#34;icmp&#34; reject&#39;</span> --timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用日志功能 log, 可以在 /var/log/messages 或 /var/log/syslog 文件中查看</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 source address=192.168.1.0/24 port port=&#34;8100&#34; log prefix=&#34;Port: 8100 Access&#34; level=&#34;notice&#34; accept&#39;</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 port port=&#34;8100&#34; protocol=&#34;tcp&#34; log prefix=&#34;Port: 8100 Access&#34; level=&#34;notice&#34; accept&#39;</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 port port=&#34;8100&#34; protocol=&#34;tcp&#34; limit value=1/m log prefix=&#34;Port: 8100 Access&#34; level=&#34;notice&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 限制数据包的速率</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source address=&#34;0.0.0.0/0&#34; port port=&#34;8100&#34; protocol=&#34;tcp&#34; limit value=&#34;1/m&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h3 id=84-修改-rich-代码>.8.4. 修改 rich 代码</h3><ul><li>先删除 rich</li><li>再添加 rich</li></ul><h3 id=85-删除-rich-代码>.8.5. 删除 rich 代码</h3><ul><li><code>--add-rich-rule</code> 改成 <code>--remove-rich-rule</code> ,后面的命令不变</li></ul><p>例如:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 添加</span>
</span></span><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule protocol value=icmp reject&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除</span>
</span></span><span style=display:flex><span>firewall-cmd --remove-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule protocol value=icmp reject&#39;</span>
</span></span><span style=display:flex><span>firewall-cmd --remove-rile-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; port port=&#34;8100&#34; protocol=&#34;tcp&#34; accept&#39;</span>
</span></span></code></pre></div><h3 id=86-rich-添加备注>.8.6. rich 添加备注</h3><ul><li>firewall-cmd 本身没有备注功能，此处使用 log 允当备注功能</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --add-rich-rule<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rule family=ipv4 source address=192.168.1.0/24 port port=&#34;8100&#34; log prefix=&#34;ZhangSan IP Access&#34; level=&#34;notice&#34; accept&#39;</span>
</span></span></code></pre></div><h3 id=87-查看-rich-规则>.8.7. 查看 rich 规则</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --list-rich-rules
</span></span><span style=display:flex><span>firewall-cmd --list-all
</span></span></code></pre></div><h2 id=9-ipset-使用>.9. Ipset 使用</h2><blockquote><p>IPset 是一种高效的数据结构，用于管理大量 IP 地址的集合</p></blockquote><h3 id=91-创建-ipset>.9.1. 创建 ipset</h3><blockquote><p>使用 <code>--new-ipset</code> 参数可以创建一个新的 IPset。例如，创建名为<code>k8s</code>的 IPset：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --new-ipset<span style=color:#f92672>=</span>k8s --type<span style=color:#f92672>=</span>hash:ip
</span></span></code></pre></div><p>这将创建一个类型为 <code>hash:ip</code> 的新 IPset,它适用于大规模的 IP 地址范围，具有快速的查找和插入性能。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查询支持 IPset 类型</span>
</span></span><span style=display:flex><span>firewall-cmd --get-ipset-types
</span></span><span style=display:flex><span>hash:ip hash:ip,mark hash:ip,port hash:ip,port,ip hash:ip,port,net hash:mac hash:net hash:net,iface hash:net,net hash:net,port hash:net,port,net
</span></span></code></pre></div><h3 id=92-添加-ip-到-ipset>.9.2. 添加 IP 到 IPset</h3><blockquote><p>使用 <code>--add-entry</code> 参数可以将 IP 添加到 IPset 中。例如，将 IP <code>192.168.1.100</code> 添加到 <code>k8s</code>：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>firewall-cmd --permanent --ipset<span style=color:#f92672>=</span>k8s --add-entry<span style=color:#f92672>=</span>192.168.1.100
</span></span><span style=display:flex><span>firewall-cmd --permanent --ipset<span style=color:#f92672>=</span>k8s --add-entry<span style=color:#f92672>=</span>192.168.1.101
</span></span><span style=display:flex><span>firewall-cmd --permanent --ipset<span style=color:#f92672>=</span>k8s --add-entry<span style=color:#f92672>=</span>192.168.1.102
</span></span><span style=display:flex><span>firewall-cmd --permanent --ipset<span style=color:#f92672>=</span>k8s --add-entry<span style=color:#f92672>=</span>192.168.1.103
</span></span></code></pre></div><p>这将把 IP <code>192.168.1.100~192.168.1.103</code> 添加到名为 <code>k8s</code> 的 IPset 中。</p><h3 id=93-删除-ipset-删除-ip>.9.3. 删除 IPset 删除 IP</h3><blockquote><p>使用 <code>--remove-entry</code> 参数可以从 IPset 中删除指定的 IP。例如，从 <code>k8s</code> 中删除 IP <code>192.168.1.100</code>：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo firewall-cmd --permanent --ipset<span style=color:#f92672>=</span>k8s --remove-entry<span style=color:#f92672>=</span>192.168.1.100
</span></span></code></pre></div><p>这将从名为 <code>k8s</code> 的 IPset 中删除 IP <code>192.168.1.100</code>。</p><h3 id=94-查询-ipset>.9.4. 查询 IPset</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查询 ipset 名称</span>
</span></span><span style=display:flex><span>firewall-cmd --get-ipsets
</span></span><span style=display:flex><span>k8s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询添加的IP列表</span>
</span></span><span style=display:flex><span>firewall-cmd --ipset<span style=color:#f92672>=</span>k8s --get-entries
</span></span></code></pre></div><h3 id=95-使用-ipset>.9.5. 使用 IPset</h3><blockquote><p>创建一个规则，允许来自 <code>k8s</code> 中的 IP 访问某个服务：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 允许 IPset 里的 IP 通行</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule <span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source ipset=&#34;k8s&#34; accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 禁止 IPset 里的 IP 访问 22 端口</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule <span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source ipset=&#34;k8s&#34; port port=22 protocol=tcp reject&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 允许 IPset 里的 IP 访问 22 端口</span>
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-rich-rule <span style=color:#e6db74>&#39;rule family=&#34;ipv4&#34; source ipset=&#34;k8s&#34; port port=22 protocol=tcp accept&#39;</span>
</span></span></code></pre></div><p>这将允许来自 <code>k8s</code> 中的 IP 访问目标端口为 80 的 TCP 服务。</p><h3 id=96-删除-ipset>.9.6. 删除 IPset</h3><blockquote><p>使用 <code>--delete-ipset</code> 参数可以删除指定的 IPset。例如，删除 <code>k8s</code>：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo firewall-cmd --permanent --delete-ipset<span style=color:#f92672>=</span>k8s
</span></span></code></pre></div><p>这将删除名为 <code>k8s</code> 的 IPset。</p><p>注意：使用 <code>--permanent</code> 参数将修改永久保存并在启动时加载防火墙规则。如果你想立即生效而不重启防火墙服务，可以执行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo firewall-cmd --reload
</span></span></code></pre></div><h2 id=10-常见设置>.10. 常见设置</h2><h3 id=101-更改-backends>.10.1. 更改 Backends</h3><blockquote><p>常见的 firewalld 后端引擎 nftables, iptables 等。</p></blockquote><ol><li>从 Firewalld 0.6.0 版本开始，默认后端由 iptables 切换为了 Nftables。Nftables 是 Linux 内核中的一个新的防火墙框架，提供了更强大和灵活的防火墙规则管理功能。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查看防火墙版本</span>
</span></span><span style=display:flex><span>firewall-cmd --version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># edit</span>
</span></span><span style=display:flex><span>vim /etc/firewalld/firewalld.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FirewallBackend<span style=color:#f92672>=</span>nftables
</span></span><span style=display:flex><span>或
</span></span><span style=display:flex><span>FirewallBackend<span style=color:#f92672>=</span>iptables
</span></span></code></pre></div><h3 id=102-允许内网通行>.10.2. 允许内网通行</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 允许局域网IP和端口全部通过</span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>trusted --set-target<span style=color:#f92672>=</span>ACCEPT --permanent
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>trusted --add-source<span style=color:#f92672>=</span>127.0.0.1/32 --add-source<span style=color:#f92672>=</span>192.168.9.0/24 --permanent
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>trusted --add-port<span style=color:#f92672>=</span>0-65535/tcp --add-port<span style=color:#f92672>=</span>0-65535/udp --permanent
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>trusted --add-masquerade --permanent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h2 id=11-排障思路>.11. 排障思路</h2><ol><li>查询防火墙的状态</li><li>查看各区域的的规则设置</li><li>查看 Direct 规则</li><li>使用 <code>--permanent</code> 时，一定记得使用 <code>firewall-cmd --reload</code> 规则才会生效</li><li>找台其它机器测试添加的规则是否生效</li></ol><h2 id=12-参考>.12. 参考</h2><ul><li><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/configuring_complex_firewall_rules_with_the_rich-language_syntax target=_blank>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/configuring_complex_firewall_rules_with_the_rich-language_syntax</a></li><li><a href=https://www.sbarjatiya.com/notes_wiki/index.php/CentOS_8.x_firewalld_rich_rules target=_blank>https://www.sbarjatiya.com/notes_wiki/index.php/CentOS_8.x_firewalld_rich_rules</a></li><li><a href=https://www.computernetworkingnotes.com/linux-tutorials/firewalld-rich-rules-explained-with-examples.html target=_blank>https://www.computernetworkingnotes.com/linux-tutorials/firewalld-rich-rules-explained-with-examples.html</a></li></ul><hr><div class=footer><a class=previous-post href="https://yezihack.github.io/posts/chronyd/?ref=footer"><span style=font-weight:700>« Previous</span><br>Linux Chronyd 极简教程</a><div class=next-post><a href="https://yezihack.github.io/posts/wsl-install/?ref=footer"><span style=font-weight:700>Next »</span><br>Windows 子系统 Linux 系统之 WSL2 安装</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#1-什么是-firewalld>.1. 什么是 Firewalld</a></li><li><a href=#2-工作原理>.2. 工作原理</a></li><li><a href=#3-架构图>.3. 架构图</a></li><li><a href=#4-安装>.4. 安装</a></li><li><a href=#5-firewalld-区域管理>.5. Firewalld 区域管理</a><ul><li><a href=#51-firewalld-区域的指导>.5.1. firewalld 区域的指导</a></li><li><a href=#52-区域管理命令>.5.2. 区域管理命令</a></li></ul></li><li><a href=#6-基本命令>.6. 基本命令</a></li><li><a href=#7-实战>.7. 实战</a><ul><li><a href=#71-新增区域>.7.1. 新增区域</a></li><li><a href=#72-设置默认区域>.7.2. 设置默认区域</a></li><li><a href=#73-添加网络接口>.7.3. 添加网络接口</a></li><li><a href=#74-添加服务>.7.4. 添加服务</a></li><li><a href=#75-添加端口>.7.5. 添加端口</a></li><li><a href=#76-转发端口>.7.6. 转发端口</a></li><li><a href=#77-开启网络地址伪装转换>.7.7. 开启网络地址伪装转换</a></li><li><a href=#78-使用-direct>.7.8. 使用 direct</a></li></ul></li><li><a href=#8-rich-规则使用>.8. Rich 规则使用</a><ul><li><a href=#81-rich-规则格式>.8.1. rich 规则格式</a></li><li><a href=#82-rich-规则结构>.8.2. rich 规则结构</a></li><li><a href=#83-添加-rich-代码>.8.3. 添加 rich 代码</a></li><li><a href=#84-修改-rich-代码>.8.4. 修改 rich 代码</a></li><li><a href=#85-删除-rich-代码>.8.5. 删除 rich 代码</a></li><li><a href=#86-rich-添加备注>.8.6. rich 添加备注</a></li><li><a href=#87-查看-rich-规则>.8.7. 查看 rich 规则</a></li></ul></li><li><a href=#9-ipset-使用>.9. Ipset 使用</a><ul><li><a href=#91-创建-ipset>.9.1. 创建 ipset</a></li><li><a href=#92-添加-ip-到-ipset>.9.2. 添加 IP 到 IPset</a></li><li><a href=#93-删除-ipset-删除-ip>.9.3. 删除 IPset 删除 IP</a></li><li><a href=#94-查询-ipset>.9.4. 查询 IPset</a></li><li><a href=#95-使用-ipset>.9.5. 使用 IPset</a></li><li><a href=#96-删除-ipset>.9.6. 删除 IPset</a></li></ul></li><li><a href=#10-常见设置>.10. 常见设置</a><ul><li><a href=#101-更改-backends>.10.1. 更改 Backends</a></li><li><a href=#102-允许内网通行>.10.2. 允许内网通行</a></li></ul></li><li><a href=#11-排障思路>.11. 排障思路</a></li><li><a href=#12-参考>.12. 参考</a></li></ul></nav></div></div></div></body></html>