<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.14549c76bbc96f0af1574b0259efd70e52908cd36fb4d14ed3d290a1b6479eae.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>空树之空 - 云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15</title><meta property="og:title" content="空树之空 - 云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15"><meta name=twitter:title content="空树之空 - 云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15"><meta itemprop=name content="空树之空 - 云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15"><meta name=application-name content="空树之空 - 云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15"><meta property="og:site_name" content="空树之空"><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/><link rel=canonical href=https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/ itemprop=url><meta name=url content="https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/"><meta name=twitter:url content="https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/"><meta property="og:url" content="https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/"><meta property="og:updated_time" content="9012-09-04T1226:37:22+0800"><link rel=sitemap type=application/xml title=Sitemap href=https://yezihack.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content="空树之空"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="9012-09-04T1226:37:22+0800"><meta property="article:published_time" content="9012-09-04T1226:37:22+0800"><meta property="og:article:author" content="百里"><meta property="article:author" content="百里"><meta name=author content="百里"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15","author":{"@type":"Person","name":""},"datePublished":"2022-12-09","description":"","wordCount":"651","mainEntityOfPage":"True","dateModified":"2022-12-09","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"空树之空","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.114.0"><link type=text/css rel=stylesheet href=/css/bundle.min.aa949ea27ee9836d60d6ea4c073fd0885f51948c7eea0247da6b1aff4bc25c44.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body class=dark-theme><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://yezihack.github.io/><img src=/images/head.jpg alt="brand image"></a>
<a href=https://yezihack.github.io/><h1>空树之空</h1></a></h1><p class=lead>《空樹之空》博客是一个技术导向的平台，聚焦于Kubernetes、DevOps和Linux等领域。通过简洁而优美的文字，我们提供对这些技术主题的深入探索和实用的指南。</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://yezihack.github.io/posts/helm-command/>Helm 常用命令</a></li><li class=bullet><a href=https://yezihack.github.io/posts/helm-template/>Helm Chart 模板</a></li><li class=bullet><a href=https://yezihack.github.io/posts/helm-tutorial/>Helm 入门学习</a></li><li class=bullet><a href=https://yezihack.github.io/posts/vm-share-dir/>Vmware 虚拟机共享宿主机文件夹</a></li><li class=bullet><a href=https://yezihack.github.io/posts/haproxy-keepalived/>Haproxy + Keepalived 实现 k8s 集群高可用</a></li><li class=heading><a href=/tags/>Tags</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=https://yezihack.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote><br>&copy; 2023 百里江山. All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://yezihack.github.io/posts/kubeadm-upgrade-v1.16/>云运维笔记(8) Kubeadm 内网补丁版本升级，从v1.16.0至v1.16.15</a></h1><time datetime=2022-12-09T16:26:37+0800 class=post-date>December 9, 2022</time><ul class=tags><li class=tag-linux><a href=https://yezihack.github.io/tags/linux>linux</a></li><li class=tag-教程><a href=https://yezihack.github.io/tags/%E6%95%99%E7%A8%8B>教程</a></li><li class=tag-云运维笔记><a href=https://yezihack.github.io/tags/%E4%BA%91%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0>云运维笔记</a></li><li class=tag-kubeadm><a href=https://yezihack.github.io/tags/kubeadm>kubeadm</a></li><li class=tag-k8s><a href=https://yezihack.github.io/tags/k8s>k8s</a></li></ul></div><h2 id=1-为什么升级>.1. 为什么升级</h2><ul><li>漏洞问题</li><li>使用新功能</li></ul><h2 id=2-特殊性>.2. 特殊性</h2><ul><li>内网环境，没有外网。</li><li>多 master 集群。</li><li>外置 Etcd。</li></ul><h2 id=3-版本>.3. 版本</h2><ul><li>kubeadm升级前版本：v1.16.0</li><li>kubeadm升级后版本：v1.16.15</li></ul><h2 id=4-升级前的检查>.4. 升级前的检查</h2><h3 id=41-查看当前版本>.4.1. 查看当前版本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubeadm version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm version: &amp;version.Info<span style=color:#f92672>{</span>Major:<span style=color:#e6db74>&#34;1&#34;</span>, Minor:<span style=color:#e6db74>&#34;16&#34;</span>, GitVersion:<span style=color:#e6db74>&#34;v1.16.0&#34;</span>, GitCommit:<span style=color:#e6db74>&#34;72c30166b2105cd7d3350f2c28a219e6abcd79eb&#34;</span>, GitTreeState:<span style=color:#e6db74>&#34;clean&#34;</span>, BuildDate:<span style=color:#e6db74>&#34;2020-01-18T23:29:13Z&#34;</span>, GoVersion:<span style=color:#e6db74>&#34;go1.13.5&#34;</span>, Compiler:<span style=color:#e6db74>&#34;gc&#34;</span>, Platform:<span style=color:#e6db74>&#34;linux/amd64&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=42-离线下载-kubectlkubeadmkubelet-下载>.4.2. 离线下载 kubectl,kubeadm,kubelet 下载</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 必须本机没有安装以下软件</span>
</span></span><span style=display:flex><span>version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.16.15&#34;</span>
</span></span><span style=display:flex><span>yumdownloader --resolve --destdir<span style=color:#f92672>=</span>/opt/local-packages/ kubelet-<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span> kubeadm-<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span> kubectl-<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span>
</span></span></code></pre></div><h3 id=43-制作共享-yum-源>.4.3. 制作共享 YUM 源</h3><p>使用工具：<a href=https://github.com/yezihack/saber/releases/tag/v1.0.0 target=_blank>saber</a></p><p>假定本机IP：192.168.10.10</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 安装 Createrepo</span>
</span></span><span style=display:flex><span>yum install createrepo -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>createrepo /opt/local-packages/ 
</span></span><span style=display:flex><span><span style=color:#75715e># 如果存在 repodata 则使用更新</span>
</span></span><span style=display:flex><span>createrepo --update /opt/local-packages/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 共享文件</span>
</span></span><span style=display:flex><span>saber fs /opt/local-packages/
</span></span></code></pre></div><h3 id=44-设置-yum-源>.4.4. 设置 yum 源</h3><p>每台要升级的机器设置一下内网 yum 源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat &gt; /etc/yum.repos.d/local-packages.repo <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[local-packages]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=local-packages
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=http://192.168.10.10:7000/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看，设置缓存源</span>
</span></span><span style=display:flex><span>yum repolist <span style=color:#f92672>&amp;&amp;</span> yum makecache fast
</span></span></code></pre></div><h3 id=45-k8s-组件镜像下载>.4.5. k8s 组件镜像下载</h3><blockquote><p>查看指定版本的镜像</p></blockquote><p>需要将外网的镜像下载然后再上传到内网上(me.hubor.io)，必须有外网的机器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查看镜像列表</span>
</span></span><span style=display:flex><span>kubeadm config images list  --kubernetes-version<span style=color:#f92672>=</span>1.16.15 --image-repository<span style=color:#f92672>=</span>registry.aliyuncs.com/google_containers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 显示结果</span>
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/kube-apiserver:v1.16.15
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/kube-controller-manager:v1.16.15
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/kube-scheduler:v1.16.15
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/kube-proxy:v1.16.15
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/pause:3.1
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/etcd:3.3.15-0
</span></span><span style=display:flex><span>registry.aliyuncs.com/google_containers/coredns:1.6.2
</span></span></code></pre></div><p>将以上镜像上传到内网(me.hubor.io)</p><ul><li><a href=https://gist.github.com/yezihack/c57bcd84b81571faa5d2a229951c3534 target=_blank>upload-images.sh</a></li></ul><p>运行下载镜像并上传：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>chmod +x upload-images.sh 
</span></span><span style=display:flex><span>./upload-images.sh download 1.16.15
</span></span></code></pre></div><h2 id=5-执行升级>.5. 执行升级</h2><ul><li>v1.16.0 升级至 v1.16.15</li><li>控制面节点上的升级过程应该每次处理一个节点。 首先选择一个要先行升级的控制面节点。该节点上必须拥有 /etc/kubernetes/admin.conf 文件</li></ul><blockquote><p>内网环境则需要下载好需要安装的版本软件放入YUM源里。</p></blockquote><h3 id=51-升级主控制面板节点>.5.1. 升级主控制面板节点</h3><blockquote><p>本次操作机器：kube-10，该节点上必须拥有 /etc/kubernetes/admin.conf 文件</p></blockquote><ul><li>安装 kubeadm-1.16.15</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 升级 kubeadm </span>
</span></span><span style=display:flex><span>yum install -y kubeadm-1.16.15-0 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 查看版本验证升级成功</span>
</span></span><span style=display:flex><span>kubeadm version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群节点列表</span>
</span></span><span style=display:flex><span>kubectl get no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME      STATUS   ROLES    AGE    VERSION
</span></span><span style=display:flex><span>kube-10   Ready    master   9h    v1.16.0
</span></span><span style=display:flex><span>kube-11   Ready    master   8h     v1.16.0
</span></span><span style=display:flex><span>kube-12   Ready    &lt;none&gt;   8h     v1.16.0
</span></span></code></pre></div><ul><li>查看升级计划</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubeadm upgrade plan
</span></span></code></pre></div><p>显示结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>### result
</span></span><span style=display:flex><span>Upgrade to the latest stable version:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COMPONENT            CURRENT    AVAILABLE
</span></span><span style=display:flex><span>API Server           v1.16.0   v1.16.15
</span></span><span style=display:flex><span>Controller Manager  v1.16.0   v1.16.15
</span></span><span style=display:flex><span>Scheduler           v1.16.0   v1.16.15
</span></span><span style=display:flex><span>Kube Proxy          v1.16.0   v1.16.15
</span></span><span style=display:flex><span>CoreDNS              1.6.2      1.6.5
</span></span><span style=display:flex><span>Etcd                 3.3.15     3.4.3-0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You can now apply the upgrade by executing the following command:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm upgrade apply v1.16.15
</span></span></code></pre></div><p>本次不直接使用 <code>kubeadm upgrade apply v1.16.15</code>命令，因集群特殊性，采用配置文件升级。</p><ul><li>导出 kubeadm-config 配置，预先下载镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubeadm config view &gt; kubeadm-config-v1.16.15.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改</span>
</span></span><span style=display:flex><span>imageRepository: me.hubor.io/google_containers <span style=color:#75715e># 设置内网的镜像源地址</span>
</span></span><span style=display:flex><span>kind: ClusterConfiguration
</span></span><span style=display:flex><span>kubernetesVersion: v1.16.15  <span style=color:#75715e># 修改为升级目录版本</span>
</span></span></code></pre></div><p>升级 kube-10 主节点</p><blockquote><p>升级完后集群内所有的 kube-proxy 会重启一次。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 执行升级命令(模拟运行)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 适合外置 ETCD</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --certificate-renewal 禁止更新证书操作</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  --etcd-upgrade=false 禁止更新 etcd </span>
</span></span><span style=display:flex><span>kubeadm upgrade apply v1.16.15 --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --config kubeadm-config-v1.16.15.yaml --ignore-preflight-errors<span style=color:#f92672>=</span>ControlPlaneNodesReady,swap --dry-run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行升级命令(真实运行)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 适合外置 ETCD</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --certificate-renewal 禁止更新证书操作</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  --etcd-upgrade=false 禁止更新 etcd </span>
</span></span><span style=display:flex><span>kubeadm upgrade apply v1.16.15 --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --config kubeadm-config-v1.16.15.yaml --ignore-preflight-errors<span style=color:#f92672>=</span>ControlPlaneNodesReady,swap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 显示以下信息，表示成功</span>
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade/successful<span style=color:#f92672>]</span> SUCCESS! Your cluster was upgraded to <span style=color:#e6db74>&#34;v1.16.15&#34;</span>. Enjoy!
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>升级主控制面板 kubelet, kubectl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 从集群中驱逐升级的节点</span>
</span></span><span style=display:flex><span>kubectl drain kube-10 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true --dry-run
</span></span><span style=display:flex><span>kubectl drain kube-10 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 升级 kubelet, kubectl </span>
</span></span><span style=display:flex><span>sudo yum update -y kubelet-1.16.15-0 kubectl-1.16.15-0 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启 kubelet</span>
</span></span><span style=display:flex><span>systemctl daemon-reload <span style=color:#f92672>&amp;&amp;</span> systemctl restart kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 kubelet 状态</span>
</span></span><span style=display:flex><span>systemctl status kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 取消对控制面节点的保护</span>
</span></span><span style=display:flex><span>kubectl uncordon  kube-10
</span></span></code></pre></div><ul><li>查看集群节点</li></ul><p>目前主节点已升级为 v1.16.15 版本，工作节点还是 v1.16.0 版本，接下来需要升级其它控制面板和工作节点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>-&gt; <span style=color:#75715e># k get no                </span>
</span></span><span style=display:flex><span>NAME      STATUS   ROLES    AGE    VERSION
</span></span><span style=display:flex><span>kube-10   Ready    master   9h    v1.16.15
</span></span><span style=display:flex><span>kube-11   Ready    master   8h     v1.16.0
</span></span><span style=display:flex><span>kube-12   Ready   &lt;none&gt;  8h     v1.16.0
</span></span></code></pre></div><h4 id=511-升级其他控制平面节点>.5.1.1. 升级其他控制平面节点</h4><blockquote><p>操作 kube-11 节点</p></blockquote><p>与第一个控制面节点相同，但是使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo kubeadm upgrade node
</span></span></code></pre></div><p>而不是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo kubeadm upgrade apply
</span></span></code></pre></div><p>此外，不需要执行 kubeadm upgrade plan 和更新 CNI 驱动插件的操作</p><p>先升级 kubeadm</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>yum update -y kubeadm-1.16.15 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span></code></pre></div><p>选择其它主节点，使用：<code>kubeadm upgrade node</code> 命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 外部 etcd，无须升级 etcd --etcd-upgrade=false</span>
</span></span><span style=display:flex><span>sudo kubeadm upgrade node --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --kubelet-version<span style=color:#f92672>=</span>v1.16.15 --dry-run 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 真实运行</span>
</span></span><span style=display:flex><span>sudo kubeadm upgrade node --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --kubelet-version<span style=color:#f92672>=</span>v1.16.15
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 显示以下信息，表示成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade<span style=color:#f92672>]</span> The configuration <span style=color:#66d9ef>for</span> this node was successfully updated!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade<span style=color:#f92672>]</span> Now you should go ahead and upgrade the kubelet package using your package manager.
</span></span></code></pre></div><p>升级其它控制面板 kubelet, kubectl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 从集群中驱逐升级的节点</span>
</span></span><span style=display:flex><span>kubectl drain kube-11 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true --dry-run
</span></span><span style=display:flex><span>kubectl drain kube-11 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 升级 kubelet, kubectl </span>
</span></span><span style=display:flex><span>sudo yum update -y kubelet-1.16.15-0 kubectl-1.16.15-0 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启 kubelet</span>
</span></span><span style=display:flex><span>systemctl daemon-reload <span style=color:#f92672>&amp;&amp;</span> systemctl restart kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 kubelet 状态</span>
</span></span><span style=display:flex><span>systemctl status kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 取消对控制面节点的保护</span>
</span></span><span style=display:flex><span>kubectl uncordon  kube-11
</span></span></code></pre></div><h4 id=512-升级工作节点>.5.1.2. 升级工作节点</h4><blockquote><p>操作 kube-12 节点</p></blockquote><ul><li>升级 kubeadm</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>yum update -y kubeadm-1.16.15 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span></code></pre></div><p>选择工作节点，使用：<code>kubeadm upgrade node</code> 命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 外部 etcd，无须升级 etcd --etcd-upgrade=false</span>
</span></span><span style=display:flex><span>sudo kubeadm upgrade node --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --kubelet-version<span style=color:#f92672>=</span>v1.16.15 --dry-run 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 真实运行</span>
</span></span><span style=display:flex><span>sudo kubeadm upgrade node --certificate-renewal<span style=color:#f92672>=</span>false --etcd-upgrade<span style=color:#f92672>=</span>false --kubelet-version<span style=color:#f92672>=</span>v1.16.15
</span></span></code></pre></div><p>升级工作面板 kubelet, kubectl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 通过将节点标记为不可调度并逐出工作负载，为维护做好准备。运行：</span>
</span></span><span style=display:flex><span>kubectl drain kube-12 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true --dry-run
</span></span><span style=display:flex><span>kubectl drain kube-12 --ignore-daemonsets --delete-local-data<span style=color:#f92672>=</span>true 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 升级 kubelet, kubectl </span>
</span></span><span style=display:flex><span>sudo yum update -y kubelet-1.16.15-0 kubectl-1.16.15-0 --disableexcludes<span style=color:#f92672>=</span>kubernetes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启 kubelet</span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 kubelet 状态</span>
</span></span><span style=display:flex><span>systemctl status kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 取消对控制面节点的保护</span>
</span></span><span style=display:flex><span>kubectl uncordon  kube-12
</span></span></code></pre></div><h4 id=513-验证集群的状态>.5.1.3. 验证集群的状态</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>-&gt; <span style=color:#75715e># kubectl get nodes       </span>
</span></span><span style=display:flex><span>NAME      STATUS   ROLES    AGE    VERSION
</span></span><span style=display:flex><span>kube-10   Ready    master   175m   v1.16.15
</span></span><span style=display:flex><span>kube-11   Ready    master   44m    v1.16.15
</span></span><span style=display:flex><span>kube-12   Ready   &lt;none&gt;   40m    v1.16.15
</span></span></code></pre></div><h2 id=6-参考>.6. 参考</h2><ul><li><a href=https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-upgrade/ target=_blank>kubeadm upgrade</a></li></ul><h2 id=7-关于作者>.7. 关于作者</h2><p>我的博客：<a href=https://yezihack.github.io target=_blank>https://yezihack.github.io</a></p><p>欢迎关注我的微信公众号【空树之空】，一日不学则面目可憎也，吾学也。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20210122112114.png?imageslim alt=空树之空></p><hr><div class=footer><a class=previous-post href="https://yezihack.github.io/posts/k8s-error/?ref=footer"><span style=font-weight:700>« Previous</span><br>云运维笔记(7) kubernetes 错误收集</a><div class=next-post><a href="https://yezihack.github.io/posts/k8s-dispatch/?ref=footer"><span style=font-weight:700>Next »</span><br>云运维笔记(9) Kubernetes Pod 调度策略</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#1-为什么升级>.1. 为什么升级</a></li><li><a href=#2-特殊性>.2. 特殊性</a></li><li><a href=#3-版本>.3. 版本</a></li><li><a href=#4-升级前的检查>.4. 升级前的检查</a><ul><li><a href=#41-查看当前版本>.4.1. 查看当前版本</a></li><li><a href=#42-离线下载-kubectlkubeadmkubelet-下载>.4.2. 离线下载 kubectl,kubeadm,kubelet 下载</a></li><li><a href=#43-制作共享-yum-源>.4.3. 制作共享 YUM 源</a></li><li><a href=#44-设置-yum-源>.4.4. 设置 yum 源</a></li><li><a href=#45-k8s-组件镜像下载>.4.5. k8s 组件镜像下载</a></li></ul></li><li><a href=#5-执行升级>.5. 执行升级</a><ul><li><a href=#51-升级主控制面板节点>.5.1. 升级主控制面板节点</a></li></ul></li><li><a href=#6-参考>.6. 参考</a></li><li><a href=#7-关于作者>.7. 关于作者</a></li></ul></nav></div></div></div></body></html>