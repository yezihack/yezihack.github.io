<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>第六章 Kubernetes Pod 控制器 - 空樹之空的博客</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="百里"><meta name=description content="本章节主要介绍各种Pod控制器的详细使用。 Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的"><meta name=keywords content="Go语言,MySQL,Redis,设计模式,读书笔记,人生感悟"><meta name=generator content="Hugo 0.79.1"><link rel=canonical href=/k8s-pod-controller.html><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.021cece56b7a73d45503de6c44a7f04dc9247fa4d50d932d81c81d1f76ef1efe.css integrity="sha256-Ahzs5Wt6c9RVA95sRKfwTckkf6TVDZMtgcgdH3bvHv4=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/toc.css><meta property="og:title" content="第六章 Kubernetes Pod 控制器"><meta property="og:description" content="本章节主要介绍各种Pod控制器的详细使用。 Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的"><meta property="og:type" content="article"><meta property="og:url" content="/k8s-pod-controller.html"><meta property="article:published_time" content="2021-10-28T17:45:21+08:00"><meta property="article:modified_time" content="2021-10-28T17:45:21+08:00"><meta itemprop=name content="第六章 Kubernetes Pod 控制器"><meta itemprop=description content="本章节主要介绍各种Pod控制器的详细使用。 Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的"><meta itemprop=datePublished content="2021-10-28T17:45:21+08:00"><meta itemprop=dateModified content="2021-10-28T17:45:21+08:00"><meta itemprop=wordCount content="10944"><meta itemprop=keywords content="k8s,云原生,kubernetes,"><meta name=twitter:card content="summary"><meta name=twitter:title content="第六章 Kubernetes Pod 控制器"><meta name=twitter:description content="本章节主要介绍各种Pod控制器的详细使用。 Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>空樹之空</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>首页</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>教程</a></div><ul class=mobile-submenu-list><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=mobile-menu-item><div class=mobile-menu-parent><span class=mobile-submenu-open></span><a href>自我驱动</a></div><ul class=mobile-submenu-list><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=mobile-menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><style>.fork-me-on-github{position:absolute;top:0;left:0;border:0}@media(max-width:1080px){.fork-me-on-github{display:none}}</style><a href=https://github.com/yezihack><img class=fork-me-on-github src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png alt="Fork me on GitHub"></a><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>空樹之空</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>首页</a></li><li class=menu-item><a class=menu-item-link href=/post.html>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags.html>标签云</a></li><li class=menu-item><a class=menu-item-link href=/categories.html>分类</a></li><li class=menu-item><a class="menu-item-link menu-parent" href>教程</a><ul class=submenu><li><a href=/categories/go%E6%95%99%E7%A8%8B.html>Go 实践教程</a></li><li><a href=/tags/docker%E6%95%99%E7%A8%8B.html>Docker笔记</a></li><li><a href=/tags/elk.html>ELK入门</a></li><li><a href=/tags/prometheus.html>Prometheus</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html>设计模式</a></li><li><a href=/tags/kubernetes.html>Kubernetes 笔记整理</a></li></ul></li><li class=menu-item><a class="menu-item-link menu-parent" href>自我驱动</a><ul class=submenu><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html>读书笔记</a></li><li><a href=/tags/%E5%B7%A5%E7%A8%8B%E5%B8%88.html>工程师</a></li><li><a href=/tags/%E5%88%86%E4%BA%AB.html>价值分享</a></li></ul></li><li class=menu-item><a class=menu-item-link href=/about.html>地图</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>第六章 Kubernetes Pod 控制器</h1><div class=post-meta><time datetime=2021-10-28 class=post-time>2021-10-28</time><div class=post-category><a href=/categories/kubernetes.html>kubernetes</a></div><span class=more-meta>约 10944 字</span>
<span class=more-meta>预计阅读 22 分钟</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div id=post-toc><aside><header><h3>第六章 Kubernetes Pod 控制器</h3></header><nav id=TableOfContents><ul><li><a href=#pod控制器介绍>Pod控制器介绍</a></li><li><a href=#replicasetrs>ReplicaSet(RS)</a></li><li><a href=#deploymentdeploy>Deployment(Deploy)</a></li><li><a href=#horizontal-pod-autoscalerhpa>Horizontal Pod Autoscaler(HPA)</a></li><li><a href=#daemonsetds>DaemonSet(DS)</a></li><li><a href=#job>Job</a></li><li><a href=#cronjobcj>CronJob(CJ)</a></li><li><a href=#参考>参考</a></li><li><a href=#关于作者>关于作者</a></li></ul></nav></aside><a href=# id=toc-toggle></a></div><div class=post-content><blockquote><p>本章节主要介绍各种Pod控制器的详细使用。</p></blockquote><h2 id=pod控制器介绍>Pod控制器介绍</h2><p>Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</p><ul><li><p>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</p></li><li><p>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</p></li></ul><blockquote><p><strong><code>什么是Pod控制器</code></strong></p><p>Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</p></blockquote><p>在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p><ul><li><p>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</p></li><li><p>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</p></li><li><p>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</p></li><li><p>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</p></li><li><p>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</p></li><li><p>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</p></li><li><p>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</p></li><li><p>StatefulSet：管理有状态应用</p></li></ul><h2 id=replicasetrs>ReplicaSet(RS)</h2><p>ReplicaSet的主要作用是<strong>保证一定数量的pod正常运行</strong>，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200612005334159.png?imageslim alt></p><p>ReplicaSet的资源清单文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w> </span><span class=c># 版本号</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet</span><span class=w> </span><span class=c># 类型       </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c># 元数据</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=c># rs名称 </span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=c># 所属命名空间 </span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c>#标签</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>rs</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c># 详情描述</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=c># 副本数量</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=c># 选择器，通过它指定该控制器管理哪些pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>      </span><span class=c># Labels匹配规则</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w> </span><span class=c># Expressions匹配规则</span><span class=w>
</span><span class=w>      </span>- {<span class=nt>key: app, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>nginx-pod]}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>在这里面，需要新了解的配置项就是<code>spec</code>下面几个选项：</p><ul><li>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</li><li>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制<ul><li>在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</li></ul></li><li>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</li></ul><p><strong>创建ReplicaSet</strong></p><p>创建pc-replicaset.yaml文件，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet   </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-replicaset</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> 
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建rs</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pc-replicaset.yaml</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-replicaset</span> <span class=n>created</span>

<span class=c># 查看rs</span>
<span class=c># DESIRED:期望副本数量  </span>
<span class=c># CURRENT:当前副本数量  </span>
<span class=c># READY:已经准备好提供服务的副本数量</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs pc-replicaset -n dev -o wide</span>
<span class=n>NAME</span>          <span class=n>DESIRED</span>   <span class=n>CURRENT</span> <span class=n>READY</span> <span class=n>AGE</span>   <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>             <span class=n>SELECTOR</span>
<span class=n>pc-replicaset</span> <span class=n>3</span>         <span class=n>3</span>       <span class=n>3</span>     <span class=n>22s</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span>       <span class=n>app</span><span class=p>=</span><span class=n>nginx-pod</span>

<span class=c># 查看当前控制器创建出来的pod</span>
<span class=c># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pod -n dev</span>
<span class=n>NAME</span>                          <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-replicaset</span><span class=p>-</span><span class=n>6vmvt</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>54s</span>
<span class=n>pc-replicaset-fmb8f</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>54s</span>
<span class=n>pc-replicaset-snrk2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>54s</span>
</code></pre></td></tr></table></div></div><p><strong>扩缩容</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 编辑rs的副本数量，修改spec:replicas: 6即可</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl edit rs pc-replicaset -n dev</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-replicaset</span> <span class=n>edited</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                          <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-replicaset</span><span class=p>-</span><span class=n>6vmvt</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>114m</span>
<span class=n>pc-replicaset-cftnp</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>10s</span>
<span class=n>pc-replicaset-fjlm6</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>10s</span>
<span class=n>pc-replicaset-fmb8f</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>114m</span>
<span class=n>pc-replicaset-s2whj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>10s</span>
<span class=n>pc-replicaset-snrk2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>114m</span>

<span class=c># 当然也可以直接使用命令实现</span>
<span class=c># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-replicaset</span> <span class=n>scaled</span>

<span class=c># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                       <span class=n>READY</span>   <span class=n>STATUS</span>        <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-replicaset</span><span class=p>-</span><span class=n>6vmvt</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>118m</span>
<span class=n>pc-replicaset-cftnp</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>4m17s</span>
<span class=n>pc-replicaset-fjlm6</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>4m17s</span>
<span class=n>pc-replicaset-fmb8f</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>       <span class=n>0</span>          <span class=n>118m</span>
<span class=n>pc-replicaset-s2whj</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>4m17s</span>
<span class=n>pc-replicaset-snrk2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>       <span class=n>0</span>          <span class=n>118m</span>

<span class=c>#稍等片刻，就只剩下2个了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                       <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-replicaset-fmb8f</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>119m</span>
<span class=n>pc-replicaset-snrk2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>119m</span>
</code></pre></td></tr></table></div></div><p><strong>镜像升级</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 编辑rs的容器镜像 - image: nginx:1.17.2</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl edit rs pc-replicaset -n dev</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-replicaset</span> <span class=n>edited</span>

<span class=c># 再次查看，发现镜像版本已经变更了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev -o wide</span>
<span class=n>NAME</span>                <span class=n>DESIRED</span>  <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>    <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>        <span class=p>...</span>
<span class=n>pc-replicaset</span>       <span class=n>2</span>        <span class=n>2</span>         <span class=n>2</span>       <span class=n>140m</span>   <span class=n>nginx</span>         <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>2</span>  <span class=p>...</span>

<span class=c># 同样的道理，也可以使用命令完成这个工作</span>
<span class=c># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-replicaset</span> <span class=n>image</span> <span class=n>updated</span>

<span class=c># 再次查看，发现镜像版本已经变更了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev -o wide</span>
<span class=n>NAME</span>                 <span class=n>DESIRED</span>  <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>    <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>            <span class=p>...</span>
<span class=n>pc-replicaset</span>        <span class=n>2</span>        <span class=n>2</span>         <span class=n>2</span>       <span class=n>145m</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span> <span class=p>...</span> 
</code></pre></td></tr></table></div></div><p><strong>删除ReplicaSet</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 使用kubectl delete命令会删除此RS以及它管理的Pod</span>
<span class=c># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete rs pc-replicaset -n dev</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span> <span class=s2>&#34;pc-replicaset&#34;</span> <span class=n>deleted</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pod -n dev -o wide</span>
<span class=n>No</span> <span class=n>resources</span> <span class=n>found</span> <span class=k>in</span> <span class=n>dev</span> <span class=n>namespace</span><span class=p>.</span>

<span class=c># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span> <span class=s2>&#34;pc-replicaset&#34;</span> <span class=n>deleted</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                  <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-replicaset-cl82j</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>75s</span>
<span class=n>pc-replicaset-dslhb</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>75s</span>

<span class=c># 也可以使用yaml直接删除(推荐)</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete -f pc-replicaset.yaml</span>
<span class=n>replicaset</span><span class=p>.</span><span class=n>apps</span> <span class=s2>&#34;pc-replicaset&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=deploymentdeploy>Deployment(Deploy)</h2><p>为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200612005524778.png?imageslim alt></p><p>Deployment主要功能有下面几个：</p><ul><li>支持ReplicaSet的所有功能</li><li>支持发布的停止、继续</li><li>支持滚动升级和回滚版本</li></ul><p>Deployment的资源清单文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w> </span><span class=c># 版本号</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w> </span><span class=c># 类型       </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c># 元数据</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=c># rs名称 </span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=c># 所属命名空间 </span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c>#标签</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>deploy</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c># 详情描述</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=c># 副本数量</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=c># 保留历史版本</span><span class=w>
</span><span class=w>  </span><span class=nt>paused</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 暂停部署，默认是false</span><span class=w>
</span><span class=w>  </span><span class=nt>progressDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=m>600</span><span class=w> </span><span class=c># 部署超时时间（s），默认是600</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=c># 策略</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w> </span><span class=c># 滚动更新策略</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w> </span><span class=c># 滚动更新</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w> </span><span class=c># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w> </span><span class=c># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=c># 选择器，通过它指定该控制器管理哪些pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>      </span><span class=c># Labels匹配规则</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w> </span><span class=c># Expressions匹配规则</span><span class=w>
</span><span class=w>      </span>- {<span class=nt>key: app, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>nginx-pod]}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><p><strong>创建deployment</strong></p><p>创建pc-deployment.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment      </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-deployment</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建deployment</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pc-deployment.yaml --record=true</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>created</span>

<span class=c># 查看deployment</span>
<span class=c># UP-TO-DATE 最新版本的pod的数量</span>
<span class=c># AVAILABLE  当前可用的pod的数量</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get deploy pc-deployment -n dev</span>
<span class=n>NAME</span>            <span class=n>READY</span>   <span class=n>UP-TO-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span>   <span class=n>3</span><span class=p>/</span><span class=n>3</span>     <span class=n>3</span>            <span class=n>3</span>           <span class=n>15s</span>

<span class=c># 查看rs</span>
<span class=c># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev</span>
<span class=n>NAME</span>                       <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78</span>   <span class=n>3</span>         <span class=n>3</span>         <span class=n>3</span>       <span class=n>23s</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-d2c8n</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>107s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-smpvp</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>107s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-wvjd8</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>107s</span>
</code></pre></td></tr></table></div></div><p><strong>扩缩容</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 变更副本数量为5个</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>scaled</span>

<span class=c># 查看deployment</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get deploy pc-deployment -n dev</span>
<span class=n>NAME</span>            <span class=n>READY</span>   <span class=n>UP-TO-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span>   <span class=n>5</span><span class=p>/</span><span class=n>5</span>     <span class=n>5</span>            <span class=n>5</span>           <span class=n>2m</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  kubectl get pods -n dev</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-d2c8n</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>4m19s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-jxmdq</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>94s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-mktqv</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>93s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-smpvp</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>4m19s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-wvjd8</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>4m19s</span>

<span class=c># 编辑deployment的副本数量，修改spec:replicas: 4即可</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl edit deploy pc-deployment -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>edited</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-d2c8n</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5m23s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-jxmdq</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>2m38s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-smpvp</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5m23s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78-wvjd8</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5m23s</span>
</code></pre></td></tr></table></div></div><p><strong>镜像更新</strong></p><p>deployment支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p><p>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：
type：指定策略类型，支持两种策略
Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod
RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod
rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：
maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。
maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</p><p>重建更新</p><ol><li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=c># 策略</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Recreate</span><span class=w> </span><span class=c># 重建更新</span><span class=w>
</span></code></pre></td></tr></table></div></div><ol start=2><li>创建deploy进行验证</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 变更镜像</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>image</span> <span class=n>updated</span>

<span class=c># 观察升级过程</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  kubectl get pods -n dev -w</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9</span><span class=p>-</span><span class=n>65qcw</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-w5nzv</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-xpt7w</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31s</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-xpt7w</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>41s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9</span><span class=p>-</span><span class=n>65qcw</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>41s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-w5nzv</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>   <span class=n>0</span>          <span class=n>41s</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-grn8z</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>       <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-hbl4v</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>       <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b</span><span class=p>-</span><span class=n>67nz2</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>       <span class=n>0</span>          <span class=n>0s</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-grn8z</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-hbl4v</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b</span><span class=p>-</span><span class=n>67nz2</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-grn8z</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>1s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b</span><span class=p>-</span><span class=n>67nz2</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>1s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b-hbl4v</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>2s</span>
</code></pre></td></tr></table></div></div><p>滚动更新</p><ol><li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=c># 策略</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w> </span><span class=c># 滚动更新策略</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=l>% </span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=l>%</span><span class=w>
</span></code></pre></td></tr></table></div></div><ol start=2><li>创建deploy进行验证</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 变更镜像</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>image</span> <span class=n>updated</span>

<span class=c># 观察升级过程</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -w</span>
<span class=n>NAME</span>                           <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment-c848d767</span><span class=p>-</span><span class=n>8rbzt</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31m</span>
<span class=n>pc-deployment-c848d767-h4p68</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31m</span>
<span class=n>pc-deployment-c848d767-hlmz4</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31m</span>
<span class=n>pc-deployment-c848d767-rrqcn</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>31m</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44</span><span class=p>-</span><span class=n>226rx</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44</span><span class=p>-</span><span class=n>226rx</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44</span><span class=p>-</span><span class=n>226rx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>1s</span>
<span class=n>pc-deployment-c848d767-h4p68</span>    <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>34m</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-cnd44</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-cnd44</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-cnd44</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>2s</span>
<span class=n>pc-deployment-c848d767-hlmz4</span>    <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>34m</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-px48p</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-px48p</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-px48p</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment-c848d767</span><span class=p>-</span><span class=n>8rbzt</span>    <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>34m</span>

<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-dkmqp</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-dkmqp</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44-dkmqp</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>2s</span>
<span class=n>pc-deployment-c848d767-rrqcn</span>    <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>34m</span>

<span class=c># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span>
<span class=c># 中间过程是滚动进行的，也就是边销毁边创建</span>
</code></pre></td></tr></table></div></div><p>滚动更新的过程：</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200416140251491.png?imageslim alt></p><p>镜像更新中rs的变化:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span>
<span class=c># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev</span>
<span class=n>NAME</span>                       <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78</span>   <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>7m37s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b11</span>   <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>5m37s</span>
<span class=n>pc-deployment-c848d76789</span>   <span class=n>4</span>         <span class=n>4</span>         <span class=n>4</span>       <span class=n>72s</span>
</code></pre></td></tr></table></div></div><p><strong>版本回退</strong></p><p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p><p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p><ul><li><p>status 显示当前升级状态</p></li><li><p>history 显示 升级历史记录</p></li><li><p>pause 暂停版本升级过程</p></li><li><p>resume 继续已经暂停的版本升级过程</p></li><li><p>restart 重启版本升级过程</p></li><li><p>undo 回滚到上一级版本（可以使用&ndash;to-revision回滚到指定版本）</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 查看当前升级版本的状态</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl rollout status deploy pc-deployment -n dev</span>
<span class=n>deployment</span> <span class=s2>&#34;pc-deployment&#34;</span> <span class=n>successfully</span> <span class=n>rolled</span> <span class=n>out</span>

<span class=c># 查看升级历史记录</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl rollout history deploy pc-deployment -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span>
<span class=n>REVISION</span>  <span class=n>CHANGE-CAUSE</span>
<span class=n>1</span>         <span class=n>kubectl</span> <span class=n>create</span> <span class=p>-</span><span class=n>-filename</span><span class=p>=</span><span class=n>pc-deployment</span><span class=p>.</span><span class=n>yaml</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
<span class=n>2</span>         <span class=n>kubectl</span> <span class=n>create</span> <span class=p>-</span><span class=n>-filename</span><span class=p>=</span><span class=n>pc-deployment</span><span class=p>.</span><span class=n>yaml</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
<span class=n>3</span>         <span class=n>kubectl</span> <span class=n>create</span> <span class=p>-</span><span class=n>-filename</span><span class=p>=</span><span class=n>pc-deployment</span><span class=p>.</span><span class=n>yaml</span> <span class=p>-</span><span class=n>-record</span><span class=p>=</span><span class=n>true</span>
<span class=c># 可以发现有三次版本记录，说明完成过两次升级</span>

<span class=c># 版本回滚</span>
<span class=c># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>rolled</span> <span class=n>back</span>

<span class=c># 查看发现，通过nginx镜像版本可以发现到了第一版</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get deploy -n dev -o wide</span>
<span class=n>NAME</span>            <span class=n>READY</span>   <span class=n>UP-TO-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>   <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>         
<span class=n>pc-deployment</span>   <span class=n>4</span><span class=p>/</span><span class=n>4</span>     <span class=n>4</span>            <span class=n>4</span>           <span class=n>74m</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span>   

<span class=c># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span>
<span class=c># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span>
<span class=c># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev</span>
<span class=n>NAME</span>                       <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6696798b78</span>   <span class=n>4</span>         <span class=n>4</span>         <span class=n>4</span>       <span class=n>78m</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>966bf7f44</span>    <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>37m</span>
<span class=n>pc-deployment-c848d767</span>     <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>71m</span>
</code></pre></td></tr></table></div></div><p><strong>金丝雀发布</strong></p><p>Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p><p>比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 更新deployment的版本，并配置暂停deployment</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>image</span> <span class=n>updated</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>paused</span>

<span class=c>#观察更新状态</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl rollout status deploy pc-deployment -n dev　</span>
<span class=n>Waiting</span> <span class=k>for</span> <span class=n>deployment</span> <span class=s2>&#34;pc-deployment&#34;</span> <span class=n>rollout</span> <span class=n>to</span> <span class=n>finish</span><span class=err>:</span> <span class=n>2</span> <span class=n>out</span> <span class=n>of</span> <span class=n>4</span> <span class=n>new</span> <span class=n>replicas</span> <span class=n>have</span> <span class=n>been</span> <span class=n>updated</span><span class=p>...</span>

<span class=c># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span>

<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev -o wide</span>
<span class=n>NAME</span>                       <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>     <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>         
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9</span>   <span class=n>3</span>         <span class=n>3</span>         <span class=n>3</span>       <span class=n>19m</span>     <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span>   
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b</span>   <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>14m</span>     <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>2</span>   
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb</span>   <span class=n>2</span>         <span class=n>2</span>         <span class=n>2</span>       <span class=n>3m16s</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>4</span>   
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-rj8sq</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>7m33s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-ttwgg</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>7m35s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9-v4wvc</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>7m34s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb</span><span class=p>-</span><span class=n>996rt</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>3m31s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb-j2gtj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>3m31s</span>

<span class=c># 确保更新的pod没问题了，继续更新</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl rollout resume deploy pc-deployment -n dev</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-deployment</span> <span class=n>resumed</span>

<span class=c># 查看最后的更新情况</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get rs -n dev -o wide</span>
<span class=n>NAME</span>                       <span class=n>DESIRED</span>   <span class=n>CURRENT</span>   <span class=n>READY</span>   <span class=n>AGE</span>     <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>         
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>5d89bdfbf9</span>   <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>21m</span>     <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span>   
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>675d469f8b</span>   <span class=n>0</span>         <span class=n>0</span>         <span class=n>0</span>       <span class=n>16m</span>     <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>2</span>   
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb</span>   <span class=n>4</span>         <span class=n>4</span>         <span class=n>4</span>       <span class=n>5m11s</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>4</span>   

<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>NAME</span>                             <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb</span><span class=p>-</span><span class=n>7bfwh</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>37s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb</span><span class=p>-</span><span class=n>996rt</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5m27s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb-j2gtj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5m27s</span>
<span class=n>pc-deployment</span><span class=p>-</span><span class=n>6c9f56fcfb-rf84v</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>37s</span>
</code></pre></td></tr></table></div></div><p><strong>删除Deployment</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 删除deployment，其下的rs和pod也将被删除</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete -f pc-deployment.yaml</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span> <span class=s2>&#34;pc-deployment&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=horizontal-pod-autoscalerhpa>Horizontal Pod Autoscaler(HPA)</h2><p>在前面的课程中，我们已经可以实现通过手工执行<code>kubectl scale</code>命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标&ndash;自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。</p><p>HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200608155858271.png?imageslim alt></p><p>接下来，我们来做一个实验</p><p><strong>1 安装metrics-server</strong></p><p>metrics-server可以用来收集集群中的资源使用情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 安装git</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># yum install git -y</span>
<span class=c># 获取metrics-server, 注意使用的版本</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span>
<span class=c># 修改deployment, 注意修改的是镜像和初始化参数</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># cd /root/metrics-server/deploy/1.8+/</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># vim metrics-server-deployment.yaml</span>
<span class=n>按图中添加下面选项</span>
<span class=n>hostNetwork</span><span class=err>:</span> <span class=n>true</span>
<span class=n>image</span><span class=err>:</span> <span class=n>registry</span><span class=p>.</span><span class=n>cn-hangzhou</span><span class=p>.</span><span class=n>aliyuncs</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>google_containers</span><span class=p>/</span><span class=n>metrics-server-amd64</span><span class=err>:</span><span class=n>v0</span><span class=p>.</span><span class=n>3</span><span class=p>.</span><span class=n>6</span>
<span class=n>args</span><span class=err>:</span>
<span class=p>-</span> <span class=p>-</span><span class=n>-kubelet-insecure-tls</span>
<span class=p>-</span> <span class=p>-</span><span class=n>-kubelet-preferred-address-types</span><span class=p>=</span><span class=n>InternalIP</span><span class=p>,</span><span class=n>Hostname</span><span class=p>,</span><span class=n>InternalDNS</span><span class=p>,</span><span class=n>ExternalDNS</span><span class=p>,</span><span class=n>ExternalIP</span>
</code></pre></td></tr></table></div></div><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200608163326496.png?imageslim alt=image-20200608163326496></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 安装metrics-server</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl apply -f ./</span>

<span class=c># 查看pod运行情况</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl get pod -n kube-system</span>
<span class=n>metrics-server</span><span class=p>-</span><span class=n>6b976979db</span><span class=p>-</span><span class=n>2xwbj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>90s</span>

<span class=c># 使用kubectl top node 查看资源使用情况</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl top node</span>
<span class=n>NAME</span>     <span class=n>CPU</span><span class=p>(</span><span class=n>cores</span><span class=p>)</span>   <span class=n>CPU</span><span class=p>%</span>   <span class=n>MEMORY</span><span class=p>(</span><span class=n>bytes</span><span class=p>)</span>   <span class=n>MEMORY</span><span class=p>%</span>
<span class=n>master</span>   <span class=n>98m</span>          <span class=n>4</span><span class=p>%</span>     <span class=n>1067Mi</span>          <span class=n>62</span><span class=p>%</span>
<span class=n>node1</span>    <span class=n>27m</span>          <span class=n>1</span><span class=p>%</span>     <span class=n>727Mi</span>           <span class=n>42</span><span class=p>%</span>
<span class=n>node2</span>    <span class=n>34m</span>          <span class=n>1</span><span class=p>%</span>     <span class=n>800Mi</span>           <span class=n>46</span><span class=p>%</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl top pod -n kube-system</span>
<span class=n>NAME</span>                              <span class=n>CPU</span><span class=p>(</span><span class=n>cores</span><span class=p>)</span>   <span class=n>MEMORY</span><span class=p>(</span><span class=n>bytes</span><span class=p>)</span>
<span class=n>coredns</span><span class=p>-</span><span class=n>6955765f44</span><span class=p>-</span><span class=n>7ptsb</span>          <span class=n>3m</span>           <span class=n>9Mi</span>
<span class=n>coredns</span><span class=p>-</span><span class=n>6955765f44-vcwr5</span>          <span class=n>3m</span>           <span class=n>8Mi</span>
<span class=n>etcd-master</span>                       <span class=n>14m</span>          <span class=n>145Mi</span>
<span class=p>...</span>
<span class=c># 至此,metrics-server安装完成</span>
</code></pre></td></tr></table></div></div><p><strong>2 准备deployment和servie</strong></p><p>为了操作简单,直接使用命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建deployment </span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl run nginx --image=nginx:latest --requests=cpu=100m -n dev</span>
<span class=c># 创建service</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span>

<span class=c># 查看</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl get deployment,pod,svc -n dev</span>
<span class=n>NAME</span>                    <span class=n>READY</span>   <span class=n>UP-TO-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>
<span class=n>deployment</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>47s</span>

<span class=n>NAME</span>                         <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pod</span><span class=p>/</span><span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-bh8dr</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>47s</span>

<span class=n>NAME</span>            <span class=nb>TYPE </span>      <span class=n>CLUSTER-IP</span>      <span class=n>EXTERNAL-IP</span>   <span class=n>PORT</span><span class=p>(</span><span class=n>S</span><span class=p>)</span>        <span class=n>AGE</span>
<span class=n>service</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>NodePort</span>   <span class=n>10</span><span class=p>.</span><span class=n>109</span><span class=p>.</span><span class=n>57</span><span class=p>.</span><span class=n>248</span>   <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>        <span class=n>80</span><span class=err>:</span><span class=n>31136</span><span class=p>/</span><span class=n>TCP</span>   <span class=n>35s</span>
</code></pre></td></tr></table></div></div><p><strong>3 部署HPA</strong></p><p>创建pc-hpa.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-hpa</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>  </span><span class=c>#最小pod数量</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> </span><span class=c>#最大pod数量</span><span class=w>
</span><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=c># CPU使用率指标</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>   </span><span class=c># 指定要控制的nginx信息</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment  </span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx  </span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建hpa</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl create -f pc-hpa.yaml</span>
<span class=n>horizontalpodautoscaler</span><span class=p>.</span><span class=n>autoscaling</span><span class=p>/</span><span class=n>pc-hpa</span> <span class=n>created</span>

<span class=c># 查看hpa</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=n>1</span><span class=p>.</span><span class=n>8</span><span class=p>+]</span><span class=c># kubectl get hpa -n dev</span>
<span class=n>NAME</span>     <span class=n>REFERENCE</span>          <span class=n>TARGETS</span>   <span class=n>MINPODS</span>   <span class=n>MAXPODS</span>   <span class=n>REPLICAS</span>   <span class=n>AGE</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>1</span>          <span class=n>62s</span>
</code></pre></td></tr></table></div></div><p><strong>4 测试</strong></p><p>使用压测工具对service地址<code>192.168.109.100:31136</code>进行压测，然后通过控制台查看hpa和pod的变化</p><p><code>hpa变化</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get hpa -n dev -w</span>
<span class=n>NAME</span>     <span class=n>REFERENCE</span>          <span class=n>TARGETS</span>   <span class=n>MINPODS</span>   <span class=n>MAXPODS</span>   <span class=n>REPLICAS</span>   <span class=n>AGE</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>1</span>          <span class=n>4m11s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>1</span>          <span class=n>5m19s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>22</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>    <span class=n>1</span>         <span class=n>10</span>        <span class=n>1</span>          <span class=n>6m50s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>22</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>    <span class=n>1</span>         <span class=n>10</span>        <span class=n>4</span>          <span class=n>7m5s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>22</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>    <span class=n>1</span>         <span class=n>10</span>        <span class=n>8</span>          <span class=n>7m21s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>6</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>8</span>          <span class=n>7m51s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>8</span>          <span class=n>9m6s</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>8</span>          <span class=n>13m</span>
<span class=n>pc-hpa</span>   <span class=n>Deployment</span><span class=p>/</span><span class=n>nginx</span>   <span class=n>0</span><span class=p>%/</span><span class=n>3</span><span class=p>%</span>     <span class=n>1</span>         <span class=n>10</span>        <span class=n>1</span>          <span class=n>14m</span>
</code></pre></td></tr></table></div></div><p><code>deployment变化</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get deployment -n dev -w</span>
<span class=n>NAME</span>    <span class=n>READY</span>   <span class=n>UP-TO-DATE</span>   <span class=n>AVAILABLE</span>   <span class=n>AGE</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>11m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>4</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>13m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>4</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>13m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>4</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>13m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>4</span>     <span class=n>4</span>            <span class=n>1</span>           <span class=n>13m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>8</span>     <span class=n>4</span>            <span class=n>1</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>8</span>     <span class=n>4</span>            <span class=n>1</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>8</span>     <span class=n>4</span>            <span class=n>1</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>1</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>2</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>2</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>3</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>3</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>4</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>4</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>5</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>5</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>6</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>6</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>7</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>7</span>           <span class=n>14m</span>
<span class=n>nginx</span>   <span class=n>8</span><span class=p>/</span><span class=n>8</span>     <span class=n>8</span>            <span class=n>8</span>           <span class=n>15m</span>
<span class=n>nginx</span>   <span class=n>8</span><span class=p>/</span><span class=n>1</span>     <span class=n>8</span>            <span class=n>8</span>           <span class=n>20m</span>
<span class=n>nginx</span>   <span class=n>8</span><span class=p>/</span><span class=n>1</span>     <span class=n>8</span>            <span class=n>8</span>           <span class=n>20m</span>
<span class=n>nginx</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>1</span>            <span class=n>1</span>           <span class=n>20m</span>
</code></pre></td></tr></table></div></div><p><code>pod变化</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -w</span>
<span class=n>NAME</span>                     <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-bh8dr</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>11m</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-cpgrv</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc</span><span class=p>-</span><span class=n>8zhwk</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-rr9bn</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-cpgrv</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc</span><span class=p>-</span><span class=n>8zhwk</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-rr9bn</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-m9gsj</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-g56qb</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-sl9c6</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-fgst7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-g56qb</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-m9gsj</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-sl9c6</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-fgst7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc</span><span class=p>-</span><span class=n>8zhwk</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>19s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-rr9bn</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>30s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-m9gsj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>21s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-cpgrv</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>47s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-sl9c6</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>33s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-g56qb</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>48s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-fgst7</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>66s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-fgst7</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>6m50s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc</span><span class=p>-</span><span class=n>8zhwk</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>7m5s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-cpgrv</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>7m5s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-g56qb</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>6m50s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-rr9bn</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>7m5s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-m9gsj</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>6m50s</span>
<span class=n>nginx</span><span class=p>-</span><span class=n>7df9756ccc-sl9c6</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Terminating</span>         <span class=n>0</span>          <span class=n>6m50s</span>
</code></pre></td></tr></table></div></div><h2 id=daemonsetds>DaemonSet(DS)</h2><p>DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200612010223537.png?imageslim alt></p><p>DaemonSet控制器的特点：</p><ul><li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li><li>当节点从集群中移除时，Pod 也就被垃圾回收了</li></ul><p>下面先来看下DaemonSet的资源清单文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w> </span><span class=c># 版本号</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w> </span><span class=c># 类型       </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c># 元数据</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=c># rs名称 </span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=c># 所属命名空间 </span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c>#标签</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>daemonset</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c># 详情描述</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=c># 保留历史版本</span><span class=w>
</span><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w> </span><span class=c># 更新策略</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w> </span><span class=c># 滚动更新策略</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w> </span><span class=c># 滚动更新</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=c># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=c># 选择器，通过它指定该控制器管理哪些pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>      </span><span class=c># Labels匹配规则</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w> </span><span class=c># Expressions匹配规则</span><span class=w>
</span><span class=w>      </span>- {<span class=nt>key: app, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>nginx-pod]}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>创建pc-daemonset.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet      </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-daemonset</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17.1</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建daemonset</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f  pc-daemonset.yaml</span>
<span class=n>daemonset</span><span class=p>.</span><span class=n>apps</span><span class=p>/</span><span class=n>pc-daemonset</span> <span class=n>created</span>

<span class=c># 查看daemonset</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  kubectl get ds -n dev -o wide</span>
<span class=n>NAME</span>        <span class=n>DESIRED</span>  <span class=n>CURRENT</span>  <span class=n>READY</span>  <span class=n>UP-TO-DATE</span>  <span class=n>AVAILABLE</span>   <span class=n>AGE</span>   <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>         
<span class=n>pc-daemonset</span>   <span class=n>2</span>        <span class=n>2</span>        <span class=n>2</span>      <span class=n>2</span>           <span class=n>2</span>        <span class=n>24s</span>   <span class=n>nginx</span>        <span class=n>nginx</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>1</span>   

<span class=c># 查看pod,发现在每个Node上都运行一个pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c>#  kubectl get pods -n dev -o wide</span>
<span class=n>NAME</span>                 <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=n>IP</span>            <span class=n>NODE</span>    
<span class=n>pc-daemonset</span><span class=p>-</span><span class=n>9bck8</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>37s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>43</span>   <span class=n>node1</span>     
<span class=n>pc-daemonset-k224w</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>37s</span>   <span class=n>10</span><span class=p>.</span><span class=n>244</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>74</span>   <span class=n>node2</span>      

<span class=c># 删除daemonset</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete -f pc-daemonset.yaml</span>
<span class=n>daemonset</span><span class=p>.</span><span class=n>apps</span> <span class=s2>&#34;pc-daemonset&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=job>Job</h2><p>Job，主要用于负责**批量处理(一次要处理指定数量任务)<strong>短暂的</strong>一次性(每个任务仅运行一次就结束)**任务。Job特点如下：</p><ul><li>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</li><li>当成功结束的pod达到指定的数量时，Job将完成执行</li></ul><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200618213054113.png?imageslim alt></p><p>Job的资源清单文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w> </span><span class=c># 版本号</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w> </span><span class=c># 类型       </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c># 元数据</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=c># rs名称 </span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=c># 所属命名空间 </span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c>#标签</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>job</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c># 详情描述</span><span class=w>
</span><span class=w>  </span><span class=nt>completions: 1 # 指定job需要成功运行Pods的次数。默认值</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>parallelism: 1 # 指定job在任一时刻应该并发运行Pods的数量。默认值</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>activeDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w> </span><span class=c># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span><span class=w>
</span><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w> </span><span class=c># 指定job失败后进行重试的次数。默认是6</span><span class=w>
</span><span class=w>  </span><span class=nt>manualSelector</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># 是否可以使用selector选择器选择pod，默认是false</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=c># 选择器，通过它指定该控制器管理哪些pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>      </span><span class=c># Labels匹配规则</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w> </span><span class=c># Expressions匹配规则</span><span class=w>
</span><span class=w>      </span>- {<span class=nt>key: app, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>counter-pod]}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w> </span><span class=c># 重启策略只能设置为Never或者OnFailure</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>关于重启策略设置的说明：
如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变
如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1
如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</p><p>创建pc-job.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job      </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-job</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>manualSelector</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建job</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pc-job.yaml</span>
<span class=n>job</span><span class=p>.</span><span class=n>batch</span><span class=p>/</span><span class=n>pc-job</span> <span class=n>created</span>

<span class=c># 查看job</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get job -n dev -o wide  -w</span>
<span class=n>NAME</span>     <span class=n>COMPLETIONS</span>   <span class=n>DURATION</span>   <span class=n>AGE</span>   <span class=n>CONTAINERS</span>   <span class=n>IMAGES</span>         <span class=n>SELECTOR</span>
<span class=n>pc-job</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>           <span class=n>21s</span>        <span class=n>21s</span>   <span class=n>counter</span>      <span class=n>busybox</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>30</span>   <span class=n>app</span><span class=p>=</span><span class=n>counter-pod</span>
<span class=n>pc-job</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>           <span class=n>31s</span>        <span class=n>79s</span>   <span class=n>counter</span>      <span class=n>busybox</span><span class=err>:</span><span class=n>1</span><span class=p>.</span><span class=n>30</span>   <span class=n>app</span><span class=p>=</span><span class=n>counter-pod</span>

<span class=c># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -w</span>
<span class=n>NAME</span>           <span class=n>READY</span>   <span class=n>STATUS</span>     <span class=n>RESTARTS</span>      <span class=n>AGE</span>
<span class=n>pc-job-rxg96</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>     <span class=n>0</span>            <span class=n>29s</span>
<span class=n>pc-job-rxg96</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>   <span class=n>0</span>            <span class=n>33s</span>

<span class=c># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span>
<span class=c>#  completions: 6 # 指定job需要成功运行Pods的次数为6</span>
<span class=c>#  parallelism: 3 # 指定job并发运行Pods的数量为3</span>
<span class=c>#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev -w</span>
<span class=n>NAME</span>           <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>684ft</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5s</span>
<span class=n>pc-job-jhj49</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5s</span>
<span class=n>pc-job-pfcvh</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>5s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>684ft</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>   <span class=n>0</span>          <span class=n>11s</span>
<span class=n>pc-job-v7rhr</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>     <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-v7rhr</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>     <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-v7rhr</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-jhj49</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>           <span class=n>0</span>          <span class=n>11s</span>
<span class=n>pc-job-fhwf7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-fhwf7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-pfcvh</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>           <span class=n>0</span>          <span class=n>11s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>5vg2j</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-fhwf7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>5vg2j</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Pending</span>             <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>5vg2j</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>ContainerCreating</span>   <span class=n>0</span>          <span class=n>0s</span>
<span class=n>pc-job-fhwf7</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>2s</span>
<span class=n>pc-job-v7rhr</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>2s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>5vg2j</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>             <span class=n>0</span>          <span class=n>3s</span>
<span class=n>pc-job-fhwf7</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>           <span class=n>0</span>          <span class=n>12s</span>
<span class=n>pc-job-v7rhr</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>           <span class=n>0</span>          <span class=n>12s</span>
<span class=n>pc-job</span><span class=p>-</span><span class=n>5vg2j</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>           <span class=n>0</span>          <span class=n>12s</span>

<span class=c># 删除job</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl delete -f pc-job.yaml</span>
<span class=n>job</span><span class=p>.</span><span class=n>batch</span> <span class=s2>&#34;pc-job&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=cronjobcj>CronJob(CJ)</h2><p>CronJob控制器以Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob可以在特定的时间点(反复的)去运行job任务</strong>。</p><p><img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/image-20200618213149531.png?imageslim alt></p><p>CronJob的资源清单文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w> </span><span class=c># 版本号</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w> </span><span class=c># 类型       </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c># 元数据</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=c># rs名称 </span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=c># 所属命名空间 </span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c>#标签</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>cronjob</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c># 详情描述</span><span class=w>
</span><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=c># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span><span class=w>
</span><span class=w>  </span><span class=nt>concurrencyPolicy</span><span class=p>:</span><span class=w> </span><span class=c># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span><span class=w>
</span><span class=w>  </span><span class=nt>failedJobHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=c># 为失败的任务执行保留的历史记录数，默认为1</span><span class=w>
</span><span class=w>  </span><span class=nt>successfulJobHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=c># 为成功的任务执行保留的历史记录数，默认为3</span><span class=w>
</span><span class=w>  </span><span class=nt>startingDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=c># 启动作业错误的超时时长</span><span class=w>
</span><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w> </span><span class=c># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>completions</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>parallelism</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>activeDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span><span class=w>      </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>
</span><span class=w>      </span><span class=nt>manualSelector</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>        </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w> </span><span class=l>规则</span><span class=w>
</span><span class=w>          </span>- {<span class=nt>key: app, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>counter-pod]}</span><span class=w>
</span><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>counter-pod</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never </span><span class=w>
</span><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter</span><span class=w>
</span><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-markdown data-lang=markdown>需要重点解释的几个选项：
schedule: cron表达式，用于指定任务的执行时间
	<span class=ge>*/1    *</span>      <span class=ge>*    *</span>     *
	<span class=p>&lt;</span><span class=nt>分钟</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>小时</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>日</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>月份</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>星期</span><span class=p>&gt;</span>

    分钟 值从 0 到 59.
    小时 值从 0 到 23.
    日 值从 1 到 31.
    月 值从 1 到 12.
    星期 值从 0 到 6, 0 代表星期日
    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...
concurrencyPolicy:
	Allow:   允许Jobs并发运行(默认)
	Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行
	Replace: 替换，取消当前正在运行的作业并用新作业替换它
</code></pre></td></tr></table></div></div><p>创建pc-cronjob.yaml，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pc-cronjob</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=l>cronjob</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/1 * * * *&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter</span><span class=w>
</span><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.30</span><span class=w>
</span><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s2>&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># 创建cronjob</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl create -f pc-cronjob.yaml</span>
<span class=n>cronjob</span><span class=p>.</span><span class=n>batch</span><span class=p>/</span><span class=n>pc-cronjob</span> <span class=n>created</span>

<span class=c># 查看cronjob</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get cronjobs -n dev</span>
<span class=n>NAME</span>         <span class=n>SCHEDULE</span>      <span class=n>SUSPEND</span>   <span class=n>ACTIVE</span>   <span class=n>LAST</span> <span class=n>SCHEDULE</span>   <span class=n>AGE</span>
<span class=n>pc-cronjob</span>   <span class=p>*/</span><span class=n>1</span> <span class=p>*</span> <span class=p>*</span> <span class=p>*</span> <span class=p>*</span>   <span class=n>False</span>     <span class=n>0</span>        <span class=p>&lt;</span><span class=n>none</span><span class=p>&gt;</span>          <span class=n>6s</span>

<span class=c># 查看job</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get jobs -n dev</span>
<span class=n>NAME</span>                    <span class=n>COMPLETIONS</span>   <span class=n>DURATION</span>   <span class=n>AGE</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587800</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>           <span class=n>28s</span>        <span class=n>3m26s</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587860</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>           <span class=n>28s</span>        <span class=n>2m26s</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587920</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>           <span class=n>28s</span>        <span class=n>86s</span>

<span class=c># 查看pod</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl get pods -n dev</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587800-x4tsm</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>   <span class=n>0</span>          <span class=n>2m24s</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587860-r5gv4</span>   <span class=n>0</span><span class=p>/</span><span class=n>1</span>     <span class=n>Completed</span>   <span class=n>0</span>          <span class=n>84s</span>
<span class=n>pc-cronjob</span><span class=p>-</span><span class=n>1592587920</span><span class=p>-</span><span class=n>9dxxq</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>     <span class=n>0</span>          <span class=n>24s</span>


<span class=c># 删除cronjob</span>
<span class=p>[</span><span class=n>root</span><span class=nv>@master</span> <span class=p>~]</span><span class=c># kubectl  delete -f pc-cronjob.yaml</span>
<span class=n>cronjob</span><span class=p>.</span><span class=n>batch</span> <span class=s2>&#34;pc-cronjob&#34;</span> <span class=n>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><ol><li>以上笔记来自于黑马视频课程整理.</li><li>视频入口：<a href=https://www.bilibili.com/video/BV1cK4y1L7Am>https://www.bilibili.com/video/BV1cK4y1L7Am</a></li></ol><h2 id=关于作者>关于作者</h2><p>我的博客：https://www.sgfoot.com</p><p>欢迎关注我的微信公众号【空树之空】，共同学习，一起进步~
<img src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20210122112114.png?imageslim alt=空树之空></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>百里</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-10-28</span></p><p class=copyright-item><span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><h1></h1><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/yezihack/assets/b/20200417142450.jpg?imageslim>
<span>微信打赏</span></label></div></div><footer class=post-footer><div class=post-tags><a href=/tags/k8s.html>k8s</a>
<a href=/tags/%E4%BA%91%E5%8E%9F%E7%94%9F.html>云原生</a>
<a href=/tags/kubernetes.html>kubernetes</a></div><nav class=post-nav><a class=prev href=/k8s-service.html><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">第七章 Kubernetes Service 介绍</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/k8s-pod.html><span class="next-text nav-default">第五章 Kubernetes Pod 介绍</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:freeit@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://www.github.com/yezihack rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=copyright-year>&copy;
2020 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author><a href=https://www.sgfoot.com>空樹之空</a>
</span><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span></span>
<span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.c123da21eb8e940c0619f739a9ba5a0058720dfae9a96bafc91016c54983880f.js integrity="sha256-wSPaIeuOlAwGGfc5qbpaAFhyDfrpqWuvyRAWxUmDiA8=" crossorigin=anonymous></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==='localhost')return;var hm=document.createElement("script");hm.async=true;hm.src="https://hm.baidu.com/hm.js?90b270e075265ec9aad9847f47bb1f42";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><script id=baidu_push>(function(){if(window.location.hostname==='localhost')return;var bp=document.createElement('script');bp.async=true;var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>