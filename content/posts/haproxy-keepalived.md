---
title: "Haproxy + Keepalived 实现 k8s 集群高可用"
date: 2023-07-05T11:41:00+08:00
lastmod: 2023-07-05T11:41:00+08:00
draft: false
tags: ["linux", "高可用"]
categories: ["云运维笔记"]
author: "百里"
comment: false
toc: true
reward: true
# 音乐开关，true/false
music: false
# 只支持163的音乐，在生成外链播放器获取ID
music_id: "22748787"
# 是否自动播放 1是，0否
music_auto: 1
# weight: 1
# description: ""
---

## 1. 什么是 Kubernetes 的高可用

高可用性是指系统或应用程序在面对故障或异常情况时能够保持持续运行和提供服务的能力。在构建高可用的Kubernetes集群时，可以采取以下一些高级方法和策略：

- 多节点部署：使用多个节点来部署Kubernetes集群，确保即使某个节点发生故障，其他节点仍然可以继续提供服务。

- 负载均衡：通过在集群前端引入负载均衡器，将流量分发到多个节点上，实现负载均衡和故障转移。这样即使某个节点发生故障，负载均衡器可以将流量重新路由到其他健康的节点上。

- 自动伸缩：利用Kubernetes的自动伸缩功能，根据实际负载情况自动调整集群的节点数量，以满足应用程序的需求。这样可以在高负载时增加节点数量，保证性能，而在低负载时减少节点数量，节省资源。

- 容器健康检查：通过定义容器的健康检查机制，Kubernetes可以监控容器的运行状态，并在容器出现故障或异常时自动重启或替换容器，确保应用程序的持续可用性。

- 数据备份和恢复：定期对关键数据进行备份，并建立可靠的数据恢复机制，以防止数据丢失或损坏。这可以通过使用Kubernetes的持久化存储卷（Persistent Volume）和备份工具来实现。

- 故障切换和容错：通过使用Kubernetes的故障切换功能，可以在节点或容器发生故障时自动将服务切换到备用节点或容器上，确保应用程序的连续性和可用性。

- 监控和告警：建立全面的监控系统，实时监测集群和应用程序的运行状态，并设置告警机制，及时发现和处理潜在的故障或异常情况。

通过采取这些高级方法和策略，可以有效地提高Kubernetes集群的可用性和稳定性，确保应用程序在运行时不会出现服务中断。

## 2. Haproxy + Keepalived 优缺点

Haproxy和Keepalived是常用的组合，用于实现负载均衡和高可用性的解决方案。下面是它们的优缺点：

### 2.1. Haproxy

**Haproxy的优点：**

- 高性能：Haproxy是一个高性能的负载均衡器，能够处理大量的并发连接和请求。
- 灵活的配置：Haproxy提供了丰富的配置选项，可以根据需求进行灵活的负载均衡策略和规则配置。
- 健康检查：Haproxy支持对后端服务器进行健康检查，可以自动排除故障的服务器，确保只将请求转发到健康的服务器上。
- SSL终止：Haproxy可以作为SSL终止器，将SSL/TLS连接解密后再转发给后端服务器，减轻服务器的负担。

**Haproxy 的缺点：**

- 单点故障：Haproxy本身是单点，如果Haproxy节点发生故障，可能会导致服务中断。
- 配置复杂：Haproxy的配置相对复杂，需要一定的学习和经验来正确配置和管理。
  
### 2.2. Keepalived

**Keepalived 的优点：**

- 高可用性：Keepalived可以将多个Haproxy节点组成一个高可用集群，通过VRRP协议实现故障切换，确保服务的连续性和可用性。
- 快速故障切换：Keepalived能够快速检测到主节点的故障，并将VIP（虚拟IP）迅速切换到备用节点上，减少服务中断时间。
- 简单配置：Keepalived的配置相对简单，可以快速部署和管理。

**Keepalived的缺点：**

- 配置同步：Keepalived需要确保配置文件的同步，以保证所有节点的配置一致性，这可能需要额外的配置和管理工作。
- 依赖性：Keepalived依赖于底层网络和操作系统的支持，可能受限于特定的网络环境和操作系统版本。

## 架构图

## 3. Haproxy

### 3.1. 底层原理

Keepalived 是一种用于实现高可用性的软件，其底层原理主要包括以下几个方面：

1. VRRP 协议：Keepalived 使用 VRRP（Virtual Router Redundancy Protocol）协议来实现高可用性。VRRP 协议通过将多个服务器组成一个虚拟路由器组，共同提供相同的虚拟 IP 地址，实现了服务器的冗余备份和故障切换。

2. 虚拟路由器组：多个服务器通过 Keepalived 组成一个虚拟路由器组，共同提供相同的虚拟 IP 地址。其中一个服务器被选举为主服务器（Master），其他服务器为备份服务器（Backup）。

3. 心跳检测：主备服务器之间通过周期性的心跳消息进行通信，以检测主服务器的可用性。如果备份服务器在一定时间内没有收到主服务器的心跳消息，就会触发主备切换。

4. 健康检查：Keepalived 支持对服务的健康检查，通过定期检查服务的可用性和性能，及时剔除故障或不可用的服务器，保证了服务的高可用性和稳定性。

5. 路由表更新：当主服务器发生故障或不可用时，备份服务器中的一台将会被选举为新的主服务器，接管虚拟 IP 地址的转发功能。同时，Keepalived 会更新路由表，将虚拟 IP 地址指向新的主服务器。

6. 通信协议：Keepalived 使用 IP 多播或单播的方式进行主备服务器之间的通信，以及与客户端之间的通信。

通过以上机制，Keepalived 实现了服务器的冗余备份和故障切换，提供了高可用性的服务。当主服务器发生故障或不可用时，备份服务器可以快速接管虚拟 IP 地址，确保服务的连续性和可靠性。同时，Keepalived 还支持健康检查和路由表更新等功能，提供了更全面的高可用性解决方案。

### 3.2. VRRP 底层原理

VRRP（Virtual Router Redundancy Protocol）是一种网络协议，用于提供网络设备的冗余和高可用性。VRRP协议通过将多个路由器组成一个虚拟路由器组（VRID），共同提供相同的虚拟IP地址，实现了路由器的冗余备份和故障切换。

VRRP协议的原理如下：

1. 虚拟路由器组：多个路由器通过VRRP协议组成一个虚拟路由器组，共同提供相同的虚拟IP地址。其中一个路由器被选举为主路由器（Master），其他路由器为备份路由器（Backup）。

2. 虚拟路由器标识（VRID）：每个虚拟路由器组都有一个唯一的虚拟路由器标识（VRID），用于区分不同的虚拟路由器组。

3. 主备切换：主路由器负责处理所有的数据流量，备份路由器处于备份状态，监控主路由器的状态。当主路由器发生故障或不可用时，备份路由器中的一台将会被选举为新的主路由器，接管虚拟IP地址的转发功能。

4. 心跳检测：主备路由器之间通过周期性的心跳消息进行通信，以检测主路由器的可用性。如果备份路由器在一定时间内没有收到主路由器的心跳消息，就会触发主备切换。

5. 路由器优先级：每个路由器都有一个优先级值，用于决定主备路由器的选举。优先级高的路由器更有可能被选举为主路由器。当主备路由器的优先级相同时，使用路由器的IP地址作为决策因素。

通过VRRP协议，可以实现路由器的冗余备份和故障切换，提高网络的可用性和可靠性。当主路由器发生故障或不可用时，备份路由器可以快速接管虚拟IP地址，确保网络的正常运行。

### 3.3. 配置

### 3.4. 安装

## 4. KeepAlived

### 4.1. 底层原理

Haproxy 是一款高性能的负载均衡器和代理服务器，其高效性能主要得益于以下几个方面的底层原理：

1. 事件驱动：Haproxy 使用事件驱动的方式处理网络连接和请求，采用单线程或少量线程处理大量并发连接，避免了线程切换和上下文切换的开销，提高了系统的并发处理能力。

2. 非阻塞 I/O：Haproxy 使用非阻塞 I/O 模型，通过使用系统调用如 epoll、kqueue 等，实现了高效的事件驱动和异步 I/O 操作，避免了传统阻塞 I/O 模型中的线程阻塞和等待，提高了系统的并发处理能力。

3. 内存管理：Haproxy 使用自己实现的内存池管理机制，减少了内存分配和释放的开销，提高了内存的利用率和系统的性能。

4. 负载均衡算法：Haproxy 支持多种负载均衡算法，如轮询、加权轮询、最少连接等，能够根据实际情况动态地选择合适的负载均衡算法，提高了系统的负载均衡能力。

5. 健康检查：Haproxy 支持对后端服务器进行健康检查，通过定期检查后端服务器的可用性和性能，及时剔除故障或不可用的服务器，保证了系统的高可用性和稳定性。

总的来说，Haproxy 在设计和实现上充分考虑了性能和效率的因素，通过事件驱动、非阻塞 I/O、内存管理、负载均衡算法和健康检查等机制，使得其能够高效地处理大量并发连接和请求，提供高性能的负载均衡和代理服务。

### 4.2. 配置

### 4.3. 安装

## 5. 参考

- <https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba>
- <https://j3ffyang.medium.com/haproxy-and-keepalived-for-multiple-kubernetes-master-nodes-985e4efa45cc>
- <https://www.kubesphere.io/zh/docs/v3.3/installing-on-linux/high-availability-configurations/set-up-ha-cluster-using-keepalived-haproxy/>



## 6. 关于作者

我的博客：<https://yezihack.github.io>

欢迎关注我的微信公众号【空树之空】，一日不学则面目可憎也，吾学也。

![空树之空](https://cdn.jsdelivr.net/gh/yezihack/assets/b/20210122112114.png?imageslim)
